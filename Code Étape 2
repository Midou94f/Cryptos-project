# Chargement des biblioth√®ques n√©cessaires
library(crayon)
library(openxlsx)
library(dplyr)
library(writexl)
library(WriteXLS)

# D√©finition des styles
question_style <- blue$bold
info_style <- white$italic
warning_style <- red$bold
success_style <- green$bold
highlight_style <- yellow$bold
info_secondary_style <- cyan$italic
error_style <- red$bold$underline
section_title_style <- magenta$bold$underline

# Chemins des fichiers
file_path <- "//Users/mehdifehri/Desktop/Technique de programmation/Data work/profil_user.xlsx"
finance_questions_path <- "//Users/mehdifehri/Desktop/Technique de programmation/Data work/Questionnaire/Banque Question Finance.xlsx"
crypto_questions_path <- "//Users/mehdifehri/Desktop/Technique de programmation/Data work/Questionnaire/Banque Question Cryptos.xlsx"

# √âtape 0 : Chargement des fichiers
load_files <- function() {
  profil_df <- read.xlsx(file_path)
  finance_questions <- read.xlsx(finance_questions_path)
  crypto_questions <- read.xlsx(crypto_questions_path)
  return(list(profil_df = profil_df, finance_questions = finance_questions, crypto_questions = crypto_questions))
}


#########################################
###################

auto_evaluation <- function() {
  cat(section_title_style("\n=== √âtape 1 : Auto-√©valuation ===\n"))
  
  # Fonction pour valider les entr√©es utilisateur
  valider_entree <- function(message) {
    repeat {
      cat(question_style(message))
      entree <- readline()
      if (grepl("^\\d+$", entree) && as.numeric(entree) >= 0 && as.numeric(entree) <= 10) {
        return(as.numeric(entree))
      } else {
        cat(error_style("Veuillez entrer un nombre valide entre 0 et 10.\n"))
      }
    }
  }
  
  # Fonction pour valider une r√©ponse "oui" ou "non"
  valider_confirmation <- function(message) {
    repeat {
      cat(question_style(message))
      confirmation <- tolower(readline())
      if (confirmation %in% c("oui", "non")) {
        return(confirmation)
      } else {
        cat(warning_style("Veuillez r√©pondre uniquement par 'oui' ou 'non'.\n"))
      }
    }
  }
  
  # √âvaluation des connaissances financi√®res
  repeat {
    niveau_financier <- valider_entree(
      paste0(
        "\nSur une √©chelle de 0 √† 10, comment √©valuez-vous vos connaissances financi√®res g√©n√©rales ?\n",
        info_style("(0 : Aucune connaissance | 10 : Connaissance parfaite) : ")
      )
    )
    cat(info_style("\nCela signifie : "))
    if (niveau_financier <= 2) {
      cat(info_style("Vos connaissances financi√®res sont tr√®s faibles voire inexistantes.\n"))
    } else if (niveau_financier <= 4) {
      cat(info_style("Vos connaissances financi√®res sont limit√©es.\n"))
    } else if (niveau_financier <= 6) {
      cat(info_style("Vos connaissances financi√®res sont moyennes.\n"))
    } else if (niveau_financier <= 8) {
      cat(info_style("Vos connaissances financi√®res sont √©lev√©es.\n"))
    } else {
      cat(success_style("Vos connaissances financi√®res sont de niveau expert.\n"))
    }
    
    confirmation <- valider_confirmation("\n√ätes-vous d'accord avec cette √©valuation ? (oui/non) : ")
    if (confirmation == "oui") {
      break
    } else {
      cat(warning_style("\nVeuillez r√©√©valuer votre niveau.\n"))
    }
  }
  
  # √âvaluation des connaissances en cryptomonnaies
  repeat {
    niveau_crypto <- valider_entree(
      paste0(
        "\nSur une √©chelle de 0 √† 10, comment √©valuez-vous vos connaissances g√©n√©rales sur les cryptomonnaies ?\n",
        info_style("(0 : Aucune connaissance | 10 : Connaissance parfaite) : ")
      )
    )
    cat(info_style("\nCela signifie : "))
    if (niveau_crypto <= 2) {
      cat(info_style("Vos connaissances en cryptomonnaies sont tr√®s faibles voire inexistantes.\n"))
    } else if (niveau_crypto <= 4) {
      cat(info_style("Vos connaissances en cryptomonnaies sont limit√©es.\n"))
    } else if (niveau_crypto <= 6) {
      cat(info_style("Vos connaissances en cryptomonnaies sont moyennes.\n"))
    } else if (niveau_crypto <= 8) {
      cat(info_style("Vos connaissances en cryptomonnaies sont √©lev√©es.\n"))
    } else {
      cat(success_style("Vos connaissances en cryptomonnaies sont de niveau expert.\n"))
    }
    
    confirmation <- valider_confirmation("\n√ätes-vous d'accord avec cette √©valuation ? (oui/non) : ")
    if (confirmation == "oui") {
      break
    } else {
      cat(warning_style("\nVeuillez r√©√©valuer votre niveau.\n"))
    }
  }
  
  cat(success_style("\nMerci d'avoir compl√©t√© l'auto-√©valuation. Passons maintenant √† l'√©tape suivante !\n"))
  
  # Retourner les r√©sultats pour les √©tapes suivantes
  return(list(niveau_financier = niveau_financier, niveau_crypto = niveau_crypto))
}


####################################
# √âtape 2 : Test de connaissances
test_de_connaissances <- function(finance_questions, crypto_questions) {
  cat(section_title_style("\n=== √âtape 2 : Test de connaissances ===\n"))
  
  # Transition apr√®s l'auto-√©valuation
  cat(info_style("\nMaintenant que vous vous √™tes √©valu√©, testons concr√®tement vos connaissances !\n"))
  ready_response <- tolower(readline(question_style("√ätes-vous pr√™t √† commencer ? (oui/non) : ")))
  
  while (!ready_response %in% c("oui", "non")) {
    cat(warning_style("Veuillez r√©pondre uniquement par 'oui' ou 'non'.\n"))
    ready_response <- tolower(readline(question_style("√ätes-vous pr√™t √† commencer ? (oui/non) : ")))
  }
  
  if (ready_response == "non") {
    cat(info_style("\nTr√®s bien, dites-nous quand vous serez pr√™t.\n"))
    cat(info_style("Tapez 'ready' pour commencer ou 'bye' si vous voulez terminer le module.\n"))
    repeat {
      ready_response <- tolower(readline("Tapez votre r√©ponse : "))
      if (ready_response == "ready") {
        break
      } else if (ready_response == "bye") {
        cat(success_style("\nMerci d'avoir particip√© jusqu'ici. Revenez quand vous serez pr√™t pour poursuivre le test. √Ä bient√¥t !\n"))
        return(NULL)
      } else {
        cat(warning_style("R√©pondez uniquement par 'ready' ou 'bye'.\n"))
      }
    }
  }
  
  tirer_questions <- function(questions, domaine) {
    cat(section_title_style(paste0("\n=== Test de connaissances en ", domaine, " ===\n")))
    questions_sample <- questions[sample(1:nrow(questions), 20), ]  # Tirer 20 questions al√©atoires
    
    score <- 0  # Initialiser le score
    total_questions <- nrow(questions_sample)  # Nombre total de questions
    
    for (i in 1:total_questions) {
      question <- questions_sample[i, ]
      reponses <- c(question$BonneR√©ponse, question$MauvaiseR√©ponse1, question$MauvaiseR√©ponse2, question$MauvaiseR√©ponse3)
      reponses <- sample(reponses)  # M√©langer les r√©ponses
      
      # Afficher la question et les r√©ponses
      cat(highlight_style(paste0("\nQuestion ", i, ": ", question$Question, "\n")))
      for (j in 1:4) {
        cat(question_style(paste0(j, ". ", reponses[j], "\n")))
      }
      
      # Boucle pour valider la r√©ponse utilisateur
      repeat {
        user_response <- readline(question_style("Votre r√©ponse (1-4) : "))
        user_response <- tolower(user_response)  # G√©rer les r√©ponses non sensibles √† la casse
        
        # V√©rifier si un cheat code est entr√©
        if (user_response == "bardella") {
          cat(error_style("\nOh noooon! Vous avez os√© prononcer le mot tabou ! Pas de d√©bats ici, juste un aller simple vers le z√©ro absolu !\n"))
          score <- score  # Pas de points ajout√©s
          return(score)  # Terminer imm√©diatement
        } else if (user_response == "sesame") {
          cat(success_style("\nBravo ! Vous avez prononc√© la formule magique : 'S√©same, ouvre-toi !' Tous les tr√©sors des bonnes r√©ponses sont maintenant √† vous !\n"))
          score <- score + (total_questions - i + 1)  # Ajouter le score des questions restantes
          return(score)  # Terminer imm√©diatement
        }
        
        # V√©rifier si la r√©ponse est un chiffre valide (1-4)
        if (user_response %in% c("1", "2", "3", "4")) {
          user_response <- as.numeric(user_response)
          
          # V√©rifier si la r√©ponse est correcte
          if (reponses[user_response] == question$BonneR√©ponse) {
            cat(success_style("Bonne r√©ponse !\n"))
            score <- score + 1
          } else {
            cat(error_style(paste0("Mauvaise r√©ponse. La bonne r√©ponse √©tait : ", question$BonneR√©ponse, "\n")))
          }
          break  # Sortir de la boucle apr√®s une r√©ponse valide
        } else {
          # Message d'erreur pour r√©ponse invalide
          cat(warning_style("Veuillez entrer un chiffre entre 1 et 4.\n"))
        }
      }
    }
    
    return(score)  # Retourner le score final
  }
  
  
  # Test de connaissances en finance
  score_finance <- tirer_questions(finance_questions, "finance")
  note_finance <- score_finance / 2  # Calculer la note sur 10
  cat(success_style(paste0("\nVotre note en finance est : ", sprintf("%.2f", note_finance), "/10.\n")))
  
  # Transition entre les tests
  cat(highlight_style("\nBravo pour avoir termin√© le test de finance ! √ätes-vous pr√™t pour le test de connaissances en cryptomonnaies ?\n"))
  ready_response <- tolower(readline("R√©pondez 'oui' pour continuer ou 'non' pour attendre : "))
  
  while (!ready_response %in% c("oui", "non")) {
    cat(warning_style("Veuillez r√©pondre uniquement par 'oui' ou 'non'.\n"))
    ready_response <- tolower(readline("R√©pondez 'oui' pour continuer ou 'non' pour attendre : "))
  }
  
  if (ready_response == "non") {
    cat(info_style("\nTr√®s bien, dites 'ready' quand vous serez pr√™t ou 'bye' pour quitter.\n"))
    repeat {
      ready_response <- tolower(readline("Tapez votre r√©ponse : "))
      if (ready_response == "ready") {
        break
      } else if (ready_response == "bye") {
        cat(success_style("\nMerci d'avoir particip√© jusqu'ici. Revenez quand vous serez pr√™t pour poursuivre le test. √Ä bient√¥t !\n"))
        return(NULL)
      } else {
        cat(warning_style("R√©pondez uniquement par 'ready' ou 'bye'.\n"))
      }
    }
  }
  
  # Test de connaissances en cryptomonnaies
  score_crypto <- tirer_questions(crypto_questions, "cryptomonnaies")
  note_crypto <- score_crypto / 2  # Calculer la note sur 10
  cat(success_style(paste0("\nVotre note en cryptomonnaies est : ", sprintf("%.2f", note_crypto), "/10.\n")))
  
  # Message de fin
  cat(success_style("\nLes r√©sultats de vos tests sont termin√©s avec succ√®s !\n"))
  cat(info_style("Nous allons √† pr√©sent vous faire un r√©capitulatif d√©taill√© de vos r√©sultats.\n"))
  cat(info_style("Puis, vous d√©couvrirez enfin quel type d'animal investisseur crypto vous √™tes ! üêæ\n"))
  
  # Retourner les notes pour l'√©tape suivante
  return(list(note_finance = note_finance, note_crypto = note_crypto))
}

##############################################################
# √âtape 3 : Restitution de vos r√©sultats et Conclusion
#############################################################


comparaison_auto_eval <- function(auto_eval_result, test_result) {
  cat(section_title_style("\n=== √âtape 3 : Restitution de vos r√©sultats ===\n"))
  
  niveau_financier <- auto_eval_result$niveau_financier
  niveau_crypto <- auto_eval_result$niveau_crypto
  note_finance <- test_result$note_finance
  note_crypto <- test_result$note_crypto
  
  # Demander au user s'il souhaite d√©couvrir ses r√©sultats
  repeat {
    cat(question_style("\nNous avons calcul√© votre niveau de connaissance global. Souhaitez-vous le d√©couvrir ? (oui/non) : "))
    afficher_resultat <- tolower(readline())
    if (afficher_resultat %in% c("oui", "non")) break
    cat(warning_style("\nVeuillez r√©pondre uniquement par 'oui' ou 'non'.\n"))
  }
  
  if (afficher_resultat == "non") {
    cat(info_style("\nDommage ! Nous √©tions impatients de vous montrer vos r√©sultats et de r√©v√©ler votre animal type. √Ä bient√¥t !\n"))
    return(NULL)
  }
  
  # Si le user accepte de voir ses r√©sultats
  cat(success_style("\nTr√®s bien ! Voici un r√©capitulatif de vos scores :\n"))
  
  # Afficher un tableau r√©capitulatif stylis√©
  recap_table <- data.frame(
    Crit√®re = c("Niveau Financier (Auto-√©valuation)", "Niveau Crypto (Auto-√©valuation)", "Note Finance (Test)", "Note Crypto (Test)"),
    Valeur = c(niveau_financier, niveau_crypto, sprintf("%.2f", note_finance), sprintf("%.2f", note_crypto))
  )
  print(recap_table)
  
  # Calcul de la moyenne g√©n√©rale pond√©r√©e
  moyenne_generale <- 0.65 * note_crypto + 0.35 * note_finance
  cat(success_style(paste0("\nVotre moyenne g√©n√©rale est de : ", highlight_style(sprintf("%.2f", moyenne_generale), "\n"))))
  
  # Expliquer la pond√©ration de la moyenne
  cat(info_style("\nNote : Cette moyenne g√©n√©rale est pond√©r√©e en faveur de vos connaissances en cryptomonnaies pour refl√©ter les objectifs de cette application.\n"))
  
  # Comparaison des scores pour les connaissances financi√®res
  cat(success_style("\nR√©sultats pour vos connaissances financi√®res :\n"))
  if (abs(note_finance - niveau_financier) <= 1) {
    cat(highlight_style("Votre perception de vos connaissances financi√®res √©tait correcte.\n"))
    cat(highlight_style("Bravo, votre √©valuation √©tait pr√©cise, vous savez √™tre r√©aliste et perspicace !\n"))
  } else if (note_finance > niveau_financier) {
    cat(highlight_style("Vous vous √™tes sous-√©valu√© dans vos connaissances financi√®res.\n"))
    cat(highlight_style("Ne soyez pas si modeste, vos connaissances sont meilleures que vous ne le pensez. Faites-vous davantage confiance !\n"))
  } else {
    cat(warning_style("Vous vous √™tes sur√©valu√© dans vos connaissances financi√®res.\n"))
    cat(highlight_style("Faite attention, car il semblerait que vous soyez un peu trop confiant. Cela pourrait jouer des tours dans vos d√©cisions futures d'investissement !\n"))
  }
  
  # Comparaison des scores pour les connaissances en cryptomonnaies
  cat(success_style("\nR√©sultats pour vos connaissances en cryptomonnaies :\n"))
  if (abs(note_crypto - niveau_crypto) <= 1) {
    cat(highlight_style("Votre perception de vos connaissances en cryptomonnaies √©tait correcte.\n"))
    cat(highlight_style("Bravo, vous avez une excellente perception de vos comp√©tences. Continuez ainsi !\n"))
  } else if (note_crypto > niveau_crypto) {
    cat(highlight_style("Vous vous √™tes sous-√©valu√© dans vos connaissances en cryptomonnaies.\n"))
    cat(highlight_style("Vous √™tes meilleur que vous ne le pensez ! Croyez un peu plus en vos capacit√©s et osez vous lancer.\n"))
  } else {
    cat(warning_style("Vous vous √™tes sur√©valu√© dans vos connaissances en cryptomonnaies.\n"))
    cat(highlight_style("Faites attention √† ne pas vous reposer sur une confiance excessive. Soyez pr√™t √† apprendre davantage !\n"))
  }
  
  # Classification de la moyenne g√©n√©rale
  cat(section_title_style("\n=== Niveau global de connaissances ===\n"))
  if (moyenne_generale < 4.5) {
    cat(info_secondary_style("\nVotre niveau de connaissance est FAIBLE.\n"))
    cat(highlight_style("Ne vous inqui√©tez pas, notre plateforme est l√† pour vous accompagner peu importe votre niveau. Continuez √† explorer et √† apprendre, vous allez progresser !\n"))
  } else if (moyenne_generale <= 6.9) {
    cat(info_secondary_style("\nVotre niveau de connaissance est MOYEN.\n"))
    cat(highlight_style("C'est un bon d√©part ! Continuez sur cette lanc√©e pour approfondir vos connaissances.\n"))
  } else {
    cat(info_secondary_style("\nVotre niveau de connaissance est √âLEV√â.\n"))
    cat(highlight_style("F√©licitations ! Vous ma√Ætrisez d√©j√† beaucoup de concepts, continuez √† exceller.\n"))
  }
  
  # Transition vers l'√©tape suivante
  cat(success_style("\nTr√®s bien, maintenant que nous connaissons vos r√©sultats...\n"))
  cat(info_style("Nous avons r√©colt√© assez d'informations pour d√©terminer votre type de personnalit√© et votre animal investisseur.\n"))
  
  # Retourner les r√©sultats pour les √©tapes suivantes
  return(list(
    note_finance = note_finance,
    note_crypto = note_crypto,
    moyenne_generale = moyenne_generale
  ))
}
##########################
# √âtape 4 : Mise √† jour des donn√©es utilisateur
###################################

mise_a_jour_profil <- function(profil_df, auto_eval_result, resultats_comparaison, output_file) {
  cat(section_title_style("\n=== Mise √† jour des donn√©es utilisateur et recherche de votre correspondance comportementale type ===\n"))
  
  # Ajouter les nouvelles colonnes avec les r√©sultats
  updated_profil_df <- profil_df
  updated_profil_df$auto_eval_finance <- auto_eval_result$niveau_financier
  updated_profil_df$auto_eval_crypto <- auto_eval_result$niveau_crypto
  updated_profil_df$note_finance <- resultats_comparaison$note_finance
  updated_profil_df$note_crypto <- resultats_comparaison$note_crypto
  updated_profil_df$moyenne_generale <- resultats_comparaison$moyenne_generale
  
  # Ajouter une nouvelle colonne pour la cat√©gorie de niveau global
  updated_profil_df$niveau_connaissance <- ifelse(
    updated_profil_df$moyenne_generale < 4.5, "Faible",
    ifelse(updated_profil_df$moyenne_generale <= 6.9, "Moyen", "√âlev√©")
  )
  
  # Sauvegarder le nouveau fichier
  write.xlsx(updated_profil_df, file = output_file, rowNames = FALSE)
  
  # Retourner le nouveau DataFrame pour v√©rification ou usage futur
  return(updated_profil_df)
}

##################################################################################
######## ANNIMAL TYPE ##################
##################################################################################

# Matrice des profils d'investisseurs et animaux associ√©s
matrice_profils <- list(
  list(capacite = "Faible", connaissance = "Faible", risque = "√âlev√©", animal = "üê¶ Dodo", description = "Le Dodo est un esprit aventureux, mais h√©las, il agit avant de r√©fl√©chir. Sa nature impulsive le pousse √† foncer dans le brouillard, souvent sans √©valuer les cons√©quences. Malgr√© une bonne dose de d√©termination, son manque de strat√©gie lui joue fr√©quemment des tours. Il vit dans l'instant pr√©sent, oubliant que les ressources ne sont pas infinies.",
       conseil = "Apprenez √† analyser avant de vous lancer. Prenez le temps de comprendre le march√© et √©vitez les d√©cisions impulsives. Travaillez sur une approche m√©thodique pour √©viter l'extinction de vos finances."),
  list(capacite = "Faible", connaissance = "Faible", risque = "Moyen", animal = "ü¶î H√©risson", description = "Timide et prudent, l‚ÄôH√©risson se recroqueville au moindre signe de danger. Cette attitude le prot√®ge des grandes catastrophes, mais peut aussi lui faire rater des opportunit√©s int√©ressantes. Il avance petit √† petit, pr√©f√©rant la s√©curit√© au risque", 
       conseil = "Diversifiez vos investissements, mais osez sortir un peu de votre zone de confort. Parfois, un petit risque calcul√© peut ouvrir des portes insoup√ßonn√©es."),
  list(capacite = "Faible", connaissance = "Faible", risque = "Faible", animal = "üêá Lapin", description = "Le Lapin est nerveux par nature. Toujours sur le qui-vive, il fuit face aux opportunit√©s, de peur de se tromper ou de perdre gros. Cette hyperactivit√© mentale peut l'√©puiser et le rendre incapable de prendre des d√©cisions solides."
       ,conseil= "Apprenez √† calmer vos craintes et √† √©valuer les opportunit√©s rationnellement. Un bon plan structur√© peut vous √©viter de passer √† c√¥t√© d‚Äôinvestissements fructueux."),
  list(capacite = "Faible", connaissance = "Moyen", risque = "√âlev√©", animal = "üêê Ch√®vre des falaises", description = "Intr√©pide et d√©termin√©, la Ch√®vre des falaises n‚Äôa pas peur de gravir des terrains accident√©s. Cependant, sa t√©m√©rit√© l‚Äôexpose √† des chutes parfois spectaculaires. Elle manque parfois de recul pour √©valuer les risques.",
       conseil =" Apprenez √† canaliser votre courage en prenant des risques mesur√©s. Ne grimpez pas sans avoir une corde de s√©curit√© : ayez toujours une strat√©gie de repli."),
  list(capacite = "Faible", connaissance = "Moyen", risque = "Moyen", animal = "ü¶¶ Loutre", description = "Curieuse et joueuse, la Loutre avance tranquillement dans la vie. Elle sait utiliser ses ressources limit√©es avec pragmatisme, pr√©f√©rant progresser lentement mais s√ªrement. Elle aime apprendre tout en s‚Äôamusant.",
       conseil= "Restez fid√®le √† votre style d√©tendu, mais investissez dans des produits stables et peu volatils pour b√¢tir lentement un portefeuille durable."),
  list(capacite = "Faible", connaissance = "Moyen", risque = "Faible", animal = "ü¶Ü Canard", description = "Le Canard est calme, observateur, et pr√©f√®re naviguer paisiblement √† la surface des choses. Il est rarement pris de panique, mais son attitude nonchalante peut l‚Äôemp√™cher d‚Äôagir au bon moment.",
       conseil= "Utilisez votre patience comme un atout, mais ne restez pas trop passif. Rep√©rez les bons moments pour agir et faites des mouvements r√©fl√©chis."),
  list(capacite = "Faible", connaissance = "√âlev√©", risque = "√âlev√©", animal = "üêç Serpent", description = "Opportuniste et rus√©, le Serpent est un ma√Ætre strat√®ge. Il sait attendre patiemment son heure pour attaquer au bon moment. Agile et calculateur, il maximise chaque opportunit√©, mais son go√ªt pour le risque peut parfois le mettre en danger.",
       conseil= "Continuez √† optimiser vos choix, mais ne mettez pas tout en jeu sur un seul coup. Pensez √† diversifier pour limiter vos risques tout en profitant de vos comp√©tences."),
  list(capacite = "Faible", connaissance = "√âlev√©", risque = "Moyen", animal = "ü¶â Hibou", description = "Sage et r√©fl√©chi, l‚ÄôHibou observe tout depuis les hauteurs. Il ne se pr√©cipite jamais, pr√©f√©rant analyser les faits avant d‚Äôagir. Sa clairvoyance lui permet de prendre des d√©cisions avis√©es, bien qu‚Äôil puisse manquer d‚Äôaudace.",
       conseil="Continuez √† vous appuyer sur vos connaissances, mais prenez un peu plus de risques calcul√©s. La prudence est un atout, mais ne vous freinez pas trop.

"),
  list(capacite = "Faible", connaissance = "√âlev√©", risque = "Faible", animal = "üêß Manchot", description = "R√©silient et m√©thodique, le Manchot compense ses limitations physiques par une incroyable capacit√© d‚Äôadaptation. Sa patience lui permet de r√©sister aux √©preuves et d‚Äôavancer malgr√© les vents contraires.",
       conseil="Conservez votre discipline et votre approche rigoureuse. Investissez dans des produits √† long terme qui correspondent √† votre endurance."),
  list(capacite = "Moyenne", connaissance = "Faible", risque = "√âlev√©", animal = "üêí Singe hurleur", description = "Curieux et plein d‚Äô√©nergie, le Singe hurleur s‚Äôaventure souvent sur des terrains inconnus sans v√©ritable plan. D√©sorganis√© et impulsif, il agit sous l‚Äôexcitation du moment, parfois au d√©triment de la prudence. Son enthousiasme est contagieux, mais il doit apprendre √† le canaliser.",
       conseil="Prenez le temps de structurer vos choix. Votre curiosit√© est un atout, mais couplez-la √† une recherche approfondie pour √©viter de prendre des risques inutiles."),
  list(capacite = "Moyenne", connaissance = "Faible", risque = "Moyen", animal = " ü¶° blaireau", description = "Endurant et d√©termin√©, le Blaireau avance avec t√©nacit√© malgr√© les obstacles. Il est connu pour sa r√©silience et son courage, mais il manque parfois de connaissances pour optimiser ses efforts. Sa capacit√© √† s'adapter dans des environnements vari√©s en fait un exemple de pers√©v√©rance. Toutefois, il peut se montrer un peu born√© face √† des conseils ext√©rieurs.",
       conseil="Votre t√©nacit√© est un atout pr√©cieux, mais apprenez √† √©largir vos connaissances avant d‚Äôagir. Diversifiez vos investissements et entourez-vous de conseils √©clair√©s pour tirer pleinement parti de votre endurance."),
  list(capacite = "Moyenne", connaissance = "Faible", risque = "Faible", animal = "ü¶• Paresseux", description = "Le Paresseux est l‚Äôincarnation de la tranquillit√©. Lent et d√©tach√©, il pr√©f√®re observer la vie passer plut√¥t que de se pr√©cipiter dans des d√©cisions. Cette attitude le prot√®ge des risques, mais le rend aussi passif face √† des opportunit√©s int√©ressantes.",
       conseil= "Apprenez √† sortir de votre confort et √† agir. Une dose d‚Äôaudace pourrait transformer votre approche en une strat√©gie gagnante."),
  list(capacite = "Moyenne", connaissance = "Moyen", risque = "√âlev√©", animal = "ü¶Ö Faucon p√®lerin", description = "Strat√®ge et visionnaire, le Faucon p√®lerin rep√®re rapidement ses opportunit√©s et plonge avec pr√©cision. Cependant, son audace et sa rapidit√© peuvent le rendre imprudent s‚Äôil ne prend pas le temps d‚Äô√©valuer tous les facteurs.",
       conseil="Continuez √† viser haut, mais prenez quelques instants pour v√©rifier vos hypoth√®ses avant de foncer. Une strat√©gie bien calibr√©e vous permettra de voler encore plus haut.

"),
  list(capacite = "Moyenne", connaissance = "Moyen", risque = "Moyen", animal = "ü¶´ Castor", description = "Travailleur acharn√©, le Castor aime b√¢tir m√©thodiquement. √âquilibr√© et pr√©voyant, il consacre du temps √† construire des fondations solides, mais il sait aussi s‚Äôadapter quand la situation l‚Äôexige.",
       conseil="Poursuivez votre strat√©gie structur√©e. Les fondations solides que vous posez aujourd‚Äôhui deviendront un atout pr√©cieux pour des investissements √† long terme."),
  list(capacite = "Moyenne", connaissance = "Moyen", risque = "Faible", animal = "üêº Panda", description = "Paisible et r√©fl√©chi, le Panda pr√©f√®re la s√©curit√© et le confort. Bien qu‚Äôil ait une personnalit√© charmante, il peut manquer d‚Äôinitiative pour sortir de sa zone de confort et explorer de nouvelles opportunit√©s.",
       conseil="Exploitez votre calme pour investir dans des options stables, mais osez exp√©rimenter des choix l√©g√®rement plus audacieux pour diversifier votre portefeuille.

"),
  list(capacite = "Moyenne", connaissance = "√âlev√©", risque = "√âlev√©", animal = "üêÖ Tigre", description = "Puissant et agile, le Tigre combine force et rapidit√© pour maximiser ses r√©sultats. Son instinct de chasseur lui permet de rep√©rer les meilleures opportunit√©s, mais son go√ªt du risque peut parfois le mettre en danger.",
       conseil="Continuez √† maximiser vos gains, mais gardez un ≈ìil sur vos limites. Diversifiez vos investissements pour s√©curiser vos succ√®s."),
  list(capacite = "Moyenne", connaissance = "√âlev√©", risque = "Moyen", animal = "ü¶ä Lynx", description = "Silencieux et observateur, le Lynx est un expert en √©valuation des opportunit√©s. Il avance discr√®tement et n‚Äôagit qu‚Äôapr√®s avoir soigneusement √©tudi√© son environnement. Cette approche m√©thodique lui permet d‚Äô√©viter les erreurs.",
       conseil="Restez fid√®le √† votre approche analytique. Elle est un atout pour d√©tecter les opportunit√©s √† moyen terme tout en limitant les risques."),
  list(capacite = "Moyenne", connaissance = "√âlev√©", risque = "Faible", animal = "üê® Koala", description = "Paisible et prudent, le Koala avance avec s√©r√©nit√©. Il choisit toujours des chemins s√ªrs et pr√©f√®re √©viter toute forme de stress. Bien qu‚Äôil soit parfois trop pr√©cautionneux, sa constance est un v√©ritable atout.",
       conseil="Continuez √† miser sur des placements stables et s√©curis√©s. Cependant, ouvrez-vous √† quelques options mod√©r√©ment risqu√©es pour augmenter l√©g√®rement votre rendement."),
  list(capacite = "√âlev√©", connaissance = "Faible", risque = "√âlev√©", animal = "üêÜ Gu√©pard", description = "Rapide et impressionnant, le Gu√©pard est un sprinter hors pair. Il agit avec une √©nergie explosive, mais son impulsivit√© peut le rendre incons√©quent. Il manque parfois de vision √† long terme et peut s'√©puiser rapidement s'il ne g√®re pas ses ressources.",
       conseil="Utilisez votre dynamisme pour saisir des opportunit√©s ponctuelles, mais apprenez √† √©quilibrer vos efforts. Pensez √† investir dans des produits √† court terme tout en √©laborant une strat√©gie durable."),
  list(capacite = "√âlev√©", connaissance = "Faible", risque = "Moyen", animal = "üê´ Chameau", description = "R√©silient et endurant, le Chameau avance avec d√©termination malgr√© des ressources parfois limit√©es. Il sait s‚Äôadapter √† des environnements difficiles et garde un ≈ìil sur ses priorit√©s. Cependant, son pragmatisme peut le rendre un peu rigide face aux nouvelles opportunit√©s.",
       conseil="Misez sur des strat√©gies √©quilibr√©es et √† long terme, mais restez ouvert √† des options plus dynamiques pour diversifier votre portefeuille."),
  list(capacite = "√âlev√©", connaissance = "Faible", risque = "Faible", animal = "ü¶å Cerf", description = "Timide et pr√©cautionneux, le Cerf pr√©f√®re √©viter les risques et rester dans un environnement s√©curis√©. Bien qu‚Äôil soit dot√© d‚Äôune grande capacit√©, il h√©site souvent √† l‚Äôexploiter pleinement par peur de l‚Äô√©chec.",
       conseil="Votre prudence est un atout, mais osez exploiter vos capacit√©s. Investissez dans des actifs s√ªrs tout en explorant prudemment des options √† faible risque.

"),
  list(capacite = "√âlev√©", connaissance = "Moyen", risque = "√âlev√©", animal = "ü¶© H√©ron", description = "Agile et pr√©cis, le H√©ron est un expert pour rep√©rer les bonnes opportunit√©s. Il sait attendre patiemment le moment id√©al pour agir, mais son go√ªt pour les d√©cisions rapides et risqu√©es peut parfois lui jouer des tours.",
       conseil="Continuez √† rep√©rer les opportunit√©s avec pr√©cision, mais prenez le temps d‚Äô√©valuer les risques avant d‚Äôagir. Une vision claire et une strat√©gie mesur√©e seront vos meilleurs alli√©s."),
  list(capacite = "√âlev√©", connaissance = "Moyen", risque = "Moyen", animal = "üêª Ours brun", description = "Puissant et stable, l‚ÄôOurs brun avance avec force et prudence. Sa patience et sa robustesse lui permettent de g√©rer les d√©fis sans perdre son calme. Cependant, il peut parfois √™tre trop lent √† r√©agir face √† des opportunit√©s urgentes.",
       conseil="Profitez de votre stabilit√© pour b√¢tir un portefeuille solide. Restez attentif aux tendances du march√© afin de ne pas manquer des occasions √† moyen terme."),
  list(capacite = "√âlev√©", connaissance = "Moyen", risque = "Faible", animal = "üê¢ Tortue g√©ante", description = "Sage et m√©thodique, la Tortue g√©ante avance lentement mais s√ªrement. Elle privil√©gie la s√©curit√© et prend des d√©cisions r√©fl√©chies. Bien que sa lenteur lui permette d‚Äô√©viter les erreurs, elle pourrait parfois acc√©l√©rer pour capter des opportunit√©s.",
       conseil="Continuez √† miser sur des placements stables et √† long terme, mais incluez quelques investissements dynamiques pour √©quilibrer votre approche."),
  list(capacite = "√âlev√©", connaissance = "√âlev√©", risque = "√âlev√©", animal = "ü¶Ö Aigle imp√©rial", description = "Visionnaire et puissant, l‚ÄôAigle imp√©rial survole les situations avec une perspective unique. Il sait rep√©rer les opportunit√©s strat√©giques gr√¢ce √† une vue d‚Äôensemble impressionnante, mais son audace peut parfois le pousser √† prendre des risques excessifs.",
       conseil="Exploitez votre vision strat√©gique, mais gardez un ≈ìil sur vos limites. Diversifiez vos placements pour assurer une croissance stable tout en maintenant un potentiel √©lev√©."),
  list(capacite = "√âlev√©", connaissance = "√âlev√©", risque = "Moyen", animal = "üê∫ Loup gris", description = "Intelligent et prudent, le Loup gris est un fin strat√®ge. Il √©value soigneusement les situations avant d‚Äôagir et maximise ses gains avec une efficacit√© redoutable. Sa capacit√© √† travailler en √©quipe ou en solo lui donne une grande flexibilit√©.",
       conseil="Continuez √† √©valuer et optimiser vos choix. Exploitez votre prudence naturelle pour √©quilibrer vos risques et b√¢tir une strat√©gie robuste."),
  list(capacite = "√âlev√©", connaissance = "√âlev√©", risque = "Faible", animal = "üêò √âl√©phant", description = "Imposant et r√©fl√©chi, l‚Äô√âl√©phant avance avec assurance. Sa sagesse et sa m√©moire exceptionnelle lui permettent de prendre des d√©cisions √©clair√©es. Bien qu‚Äôil avance lentement, il ne recule jamais devant un objectif ambitieux.",
       conseil="Restez fid√®le √† votre approche m√©thodique et r√©fl√©chie. Concentrez-vous sur des placements stables tout en explorant quelques options innovantes pour maintenir une croissance r√©guli√®re.

")
)

determine_animal_type <- function(capacite, connaissance, risque, matrice_profils) {
  profil_animal <- matrice_profils[sapply(matrice_profils, function(x) {
    x$capacite == capacite &&
      x$connaissance == connaissance &&
      x$risque == risque
  })][[1]]
  
  if (is.null(profil_animal)) {
    return(list(
      animal = "Inconnu",
      emoji = "‚ùì",
      description = "Nous n'avons pas trouv√© de profil correspondant √† vos caract√©ristiques.",
      conseil = "Aucun conseil disponible."
    ))
  }
  
  return(list(
    animal = profil_animal$animal,
    emoji = ifelse(!is.null(profil_animal$emoji), profil_animal$emoji, ""), # Emoji peut √™tre NULL
    description = profil_animal$description,
    conseil = ifelse(!is.null(profil_animal$conseil), profil_animal$conseil, "Pas de conseil disponible.")
  ))
}

# D√©couverte de l'animal type
animal_type_reveal <- function(user_data, matrice_profils) {
  cat(section_title_style("\n=== D√©couverte de votre animal type ===\n"))
  
  repeat {
    cat(question_style("Souhaitez-vous d√©couvrir votre animal type ? (oui/non) : "))
    decouvrir_animal <- tolower(readline())
    if (decouvrir_animal %in% c("oui", "non")) break
    cat(warning_style("\nVeuillez r√©pondre uniquement par 'oui' ou 'non'.\n"))
  }
  
  if (decouvrir_animal == "non") {
    cat(info_style("\nOh non, nous √©tions si pr√®s du but ! Revenez quand vous serez pr√™t.\n"))
    return(NULL)
  }
  
  profil_animal <- determine_animal_type(
    user_data$capacite_investissement,
    user_data$niveau_connaissance,
    user_data$appetit_risque_categorie,
    matrice_profils
  )
  
  # V√©rification avant affichage
  if (!is.null(profil_animal)) {
    cat(success_style("\n‚ú® D'apr√®s nos analyses sur votre profil, il semblerait que pour le moment vous soyez : ‚ú®\n"))
    cat(highlight_style(paste0(profil_animal$animal, "\n")))
    
    # Affichage de la description (v√©rification qu'elle est bien pr√©sente)
    if (!is.null(profil_animal$description) && nzchar(profil_animal$description)) {
      cat(info_style(paste0("\nDescription : ", profil_animal$description, "\n")))
    } else {
      cat(warning_style("\nDescription : Aucune description disponible pour ce profil.\n"))
    }
    
    # Affichage du conseil (v√©rification qu'il est bien pr√©sent)
    if (!is.null(profil_animal$conseil) && nzchar(profil_animal$conseil)) {
      cat(highlight_style(paste0("\nConseil : ", profil_animal$conseil, "\n")))
    } else {
      cat(warning_style("\nConseil : Aucun conseil disponible pour ce profil.\n"))
    }
    
    # Conclusion
    cat(success_style("\nConclusion : "))
    if (user_data$niveau_connaissance == "Faible") {
      cat(warning_style("Votre profil indique que vous devriez encore approfondir vos connaissances avant d'investir dans les cryptos. Pas d'inqui√©tude, notre plateforme est l√† pour vous accompagner pas √† pas. üí™\n"))
    } else if (user_data$niveau_connaissance == "Moyen") {
      cat(info_style("Votre profil est en bonne voie pour investir dans les cryptos. Avec un peu plus d'exp√©rience, vous serez pr√™t √† saisir de grandes opportunit√©s. üöÄ\n"))
    } else if (user_data$niveau_connaissance == "√âlev√©") {
      cat(success_style("F√©licitations ! Votre profil est parfaitement adapt√© pour investir dans les cryptos. Continuez √† utiliser vos connaissances pour maximiser vos r√©sultats. üèÜ\n"))
    }
    
    # Message final
    cat(info_style("\nMerci d'avoir utilis√© notre application pour d√©couvrir votre profil animal. Nous esp√©rons que ces r√©sultats vous guideront dans vos parcours d'apprentissage et vos d√©cisions d'investissement. Maintenant que vous connaissez votre type d'investisseur, nous pouvons vous offrir un acc√®s personnalis√© √† nos outils d'investissement pour maximiser votre potentiel ! üåü\n"))
  } else {
    # Gestion du cas o√π profil_animal est NULL
    cat(error_style("\nErreur : Le profil animal est introuvable. Veuillez v√©rifier les param√®tres ou les donn√©es d'entr√©e. ‚ùå\n"))
  }
  
  
  
  return(list(
    animal_type = profil_animal$animal,
    animal_description = profil_animal$description
  ))
}

start_app <- function() {
  cat(section_title_style("\n=== Bienvenue sur SmartProfile - CryptoWise Copilote ===\n"))
  cat(success_style("\nVous avez d√©j√† d√©fini les bases de votre profil investisseur lors de la premi√®re partie.\n"))
  cat(info_style("Nous avons appris √† mieux vous conna√Ætre en recueillant des informations cl√©s sur vos pr√©f√©rences de risque,\n"))
  cat(info_style("votre capacit√© financi√®re et votre horizon d‚Äôinvestissement.\n"))
  cat(highlight_style("\n--- √âtape suivante ---\n"))
  cat(info_style("Nous allons maintenant approfondir votre profil en √©valuant vos connaissances financi√®res et en cryptomonnaies.\n"))
  cat(info_style("Ces tests, combin√©s √† votre auto-√©valuation, permettront de d√©terminer votre niveau global et de finaliser votre profil type.\n"))
  cat(info_style("√Ä l‚Äôissue de cette √©tape, vous d√©couvrirez quel type d‚Äôinvestisseur vous √™tes et recevrez des recommandations adapt√©es.\n\n"))
  cat(success_style("R√©sultats attendus :\n"))
  cat(info_secondary_style("- Un retour sur votre perception de vos comp√©tences.\n"))
  cat(info_secondary_style("- Une note g√©n√©rale sur vos connaissances.\n"))
  cat(info_secondary_style("- La mise √† jour de votre profil investisseur avec votre animal type.\n\n"))
  cat(question_style("Appuyez sur Entr√©e pour continuer et plonger dans la deuxi√®me partie de l'analyse.\n"))
  readline()
  
  # √âtape 0 : Chargement des fichiers
  files <- load_files()
  profil_df <- files$profil_df
  finance_questions <- files$finance_questions
  crypto_questions <- files$crypto_questions
  
  # √âtape 1 : Auto-√©valuation
  auto_eval_result <- auto_evaluation()
  
  # √âtape 2 : Test de connaissances
  test_result <- test_de_connaissances(finance_questions, crypto_questions)
  
  # V√©rifie si l'utilisateur a compl√©t√© le test (si non, termine l'application)
  if (is.null(test_result)) {
    cat(warning_style("\nTest interrompu. Revenez quand vous serez pr√™t. Au revoir !\n"))
    return(NULL)
  }
  
  # √âtape 3 : Restitution des r√©sultats
  resultats_comparaison <- comparaison_auto_eval(auto_eval_result, test_result)
  
  # Lancer la mise √† jour du fichier utilisateur
  updated_profil_df <- mise_a_jour_profil(
    profil_df,
    auto_eval_result,
    resultats_comparaison,
    "//Users/mehdifehri/Desktop/Technique de programmation/Data work/updated_profil.xlsx"
  )
  
  # Assigner le dataframe √† l'environnement global
  assign("updated_profil_df", updated_profil_df, envir = .GlobalEnv)
  
  # √âtape 4 : D√©couverte de l'animal type
  animal_result <- animal_type_reveal(
    user_data = updated_profil_df,
    matrice_profils = matrice_profils
  )
  
  # Si l'utilisateur accepte, retourner les r√©sultats
  if (!is.null(animal_result)) {
    assign("animal_result", animal_result, envir = .GlobalEnv)
  }
}

# Cr√©ation du DataFrame profil_recap
profil_recap <- updated_profil_df %>%
  mutate(
    type_animal = animal_result$animal_type,
    description = animal_result$animal_description,
    conseil = determine_animal_type(
      capacite = updated_profil_df$capacite_investissement,
      connaissance = updated_profil_df$niveau_connaissance,
      risque = updated_profil_df$appetit_risque_categorie,
      matrice_profils = matrice_profils
    )$conseil
  )

# Enregistrement du DataFrame profil_recap
chemin_profil_recap <- "/Users/mehdifehri/Desktop/Technique de programmation/Data work/profil_recap.xlsx"
write_xlsx(profil_recap, chemin_profil_recap)

# Appel de la fonction principale pour lancer l'application
start_app()
