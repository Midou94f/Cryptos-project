############### P√©pites Hunter ###################
##############################################

# Chargement des biblioth√®ques n√©cessaires
library(crayon)  # Pour les styles de couleur
library(dplyr)   # Pour la manipulation des donn√©es
library(ggplot2) # Pour les visualisations (si n√©cessaire)
library(httr)    # Pour les appels API
library(jsonlite) # Pour travailler avec les donn√©es JSON
library(curl)
library(kableExtra)
library(cli)
library(scales)  # Pour le formatage des nombres

# D√©finition des styles
question_style <- blue$bold
info_style <- white$italic
warning_style <- red$bold
success_style <- green$bold
highlight_style <- yellow$bold
info_secondary_style <- cyan$italic
error_style <- red$bold$underline
section_title_style <- magenta$bold$underline
pro_style <- red$bold  # Style pour PRO


################################################################################
############## Signal prix 
#################################################################################

#############################
# Dataframe global pour stocker les donn√©es
coingecko_data <- NULL

# Fonction pour t√©l√©charger les donn√©es depuis CoinGecko
download_coingecko_data <- function() {
  url <- "https://api.coingecko.com/api/v3/coins/markets"
  params <- list(
    vs_currency = "usd",
    order = "market_cap_desc",
    per_page = 250,
    page = 1,
    sparkline = FALSE
  )
  
  response <- GET(url, query = params)
  
  if (status_code(response) == 200) {
    data <- fromJSON(content(response, "text", encoding = "UTF-8"))
    assign("coingecko_data", data, envir = .GlobalEnv)
    cat(success_style("\nDonn√©es t√©l√©charg√©es avec succ√®s depuis CoinGecko !\n"))
  } else {
    cat(error_style("\nErreur lors de la r√©cup√©ration des donn√©es depuis CoinGecko. V√©rifiez votre connexion ou les param√®tres API.\n"))
    assign("coingecko_data", NULL, envir = .GlobalEnv)
  }
}

####################################################
# Fonction corrig√©e pour afficher un tableau avec colonnes fixes et couleurs
display_table_fixed_colored <- function(data, title) {
  # Largeurs fixes pour chaque colonne
  col_widths <- c(40, 15, 10)  # Largeurs pour chaque colonne
  
  # Fonction pour tronquer ou remplir les colonnes
  format_column <- function(column, width) {
    sapply(column, function(x) {
      x <- substr(x, 1, width)  # Tronque les cha√Ænes trop longues
      sprintf(paste0("%-", width, "s"), x)  # Ajoute des espaces si n√©cessaire
    })
  }
  
  # Formater les en-t√™tes
  header <- sprintf(
    "%-*s | %-*s | %-*s",
    col_widths[1], "Nom",
    col_widths[2], "Symbole",
    col_widths[3], "Variation"
  )
  
  # Formater les donn√©es
  formatted_data <- data.frame(
    Nom = format_column(data$name, col_widths[1]),
    Symbole = format_column(data$symbol, col_widths[2]),
    Variation = format_column(data$price_change_percentage_24h, col_widths[3])
  )
  
  # Appliquer des couleurs aux donn√©es
  formatted_data$Nom <- cli::col_cyan(formatted_data$Nom)
  formatted_data$Symbole <- cli::col_yellow(formatted_data$Symbole)
  formatted_data$Variation <- ifelse(
    as.numeric(gsub("%", "", data$price_change_percentage_24h)) >= 0,
    cli::col_green(formatted_data$Variation),  # Vert pour positif
    cli::col_red(formatted_data$Variation)    # Rouge pour n√©gatif
  )
  
  # Afficher le titre
  cat(cli::col_magenta(title), "\n")
  
  # Afficher les en-t√™tes
  cat(header, "\n")
  
  # Ligne de s√©paration
  cat(paste0(rep("-", sum(col_widths) + 6), collapse = ""), "\n")
  
  # Afficher chaque ligne de donn√©es
  for (i in 1:nrow(formatted_data)) {
    cat(sprintf(
      "%-*s | %-*s | %-*s\n",
      col_widths[1], formatted_data$Nom[i],
      col_widths[2], formatted_data$Symbole[i],
      col_widths[3], formatted_data$Variation[i]
    ))
  }
}


##########################################################
# Fonction pour analyser les variations de prix
process_price_signals <- function(data) {
  cat(section_title_style("\n=== Signal Prix ===\n"))
  
  cat(info_style("\nDans cette section, vous trouverez les "))
  cat(highlight_style("d√©tails des variations de prix des cryptomonnaies sur les derni√®res 24 heures"))
  cat(info_style(", tri√©es selon diff√©rents crit√®res pour une analyse pr√©cise et rapide.\n\n"))
  
  cat(success_style("=== Organisation des donn√©es : ===\n"))
  cat(info_style("- Les cryptomonnaies ayant connu "))
  cat(success_style("les plus fortes progressions"))
  cat(info_style(" sur 24 heures sont list√©es par ordre d√©croissant.\n"))
  cat(info_style("- Les cryptomonnaies ayant enregistr√© "))
  cat(warning_style("les plus fortes baisses"))
  cat(info_style(" sont tri√©es par ordre croissant.\n"))
  cat(info_style("- Nous mettons √©galement en avant un classement des "))
  cat(highlight_style("10 meilleures performances"))
  cat(info_style(" et des "))
  cat(highlight_style("10 pires performances"))
  cat(info_style(", pour identifier rapidement les signaux les plus marquants.\n\n"))
  
  cat(success_style("=== Source des donn√©es : ===\n"))
  cat(info_style("Les donn√©es affich√©es ici proviennent de "))
  cat(highlight_style("l'API CoinGecko"))
  cat(info_style(", une r√©f√©rence mondiale en mati√®re d‚Äôinformations sur les cryptomonnaies. Elles sont collect√©es et mises √† jour r√©guli√®rement pour garantir leur fiabilit√©.\n\n"))
  
  cat(success_style("=== Pr√©sentation des r√©sultats : ===\n"))
  cat(info_style("Les donn√©es sont organis√©es sous forme de tableaux contenant les informations suivantes :\n"))
  cat(info_style("- "))
  cat(highlight_style("Nom de la cryptomonnaie"))
  cat(info_style(" : Identification de l‚Äôactif.\n"))
  cat(info_style("- "))
  cat(highlight_style("Symbole"))
  cat(info_style(" : Abr√©viation officielle (par exemple, BTC pour Bitcoin).\n"))
  cat(info_style("- "))
  cat(highlight_style("Variation de prix sur 24h"))
  cat(info_style(" : Exprim√©e en pourcentage, arrondie √† deux d√©cimales pour plus de clart√©.\n\n"))
  
  cat(success_style("=== Structure des r√©sultats affich√©s : ===\n"))
  cat(info_style("1. "))
  cat(highlight_style("Top 50 Progressions"))
  cat(info_style(" : Liste des cryptomonnaies ayant enregistr√© les plus fortes hausses de prix.\n"))
  cat(info_style("2. "))
  cat(highlight_style("Top 50 Baisse"))
  cat(info_style(" : Liste des cryptomonnaies ayant subi les plus fortes baisses.\n"))
  cat(info_style("3. "))
  cat(highlight_style("Signaux Haussiers (Top 10)"))
  cat(info_style(" : Les 10 actifs les plus performants.\n"))
  cat(info_style("4. "))
  cat(highlight_style("Signaux Baissiers (Top 10)"))
  cat(info_style(" : Les 10 actifs ayant connu les plus grandes baisses.\n\n"))
  
  cat(warning_style("Note : "))
  cat(info_style("Ces donn√©es fournissent une vue d‚Äôensemble claire des mouvements r√©cents sur les 24 derni√®res heures.\n\n"))
  
  ############
  
  if (is.null(data) || nrow(data) == 0) {
    cat(error_style("\nErreur : Les donn√©es ne sont pas disponibles. Veuillez v√©rifier l'appel API.\n"))
    return()
  }
  
  ################## 
  # Nettoyage et pr√©paration des donn√©es
  cleaned_data <- data %>%
    select(name, symbol, price_change_percentage_24h) %>%
    mutate(
      price_change_percentage_24h = paste0(round(as.numeric(price_change_percentage_24h), 2), "%")
    )
  
  # Top 50 Progressions
  display_table_fixed_colored(
    cleaned_data %>% arrange(desc(as.numeric(gsub("%", "", price_change_percentage_24h)))) %>% head(50),
    "Tableau des variations en % des derni√®res 24 heures : Top 50 Progressions "
  )
  cat(cli::col_green("\nCe tableau pr√©sente les cryptomonnaies ayant enregistr√© les meilleures progressions sur les derni√®res 24 heures.\n\n"))
  
  # Top 50 Baisses
  display_table_fixed_colored(
    cleaned_data %>% arrange(as.numeric(gsub("%", "", price_change_percentage_24h))) %>% head(50),
    "Tableau des variations en % des derni√®res 24 heures : Top 50 Baisses"
  )
  cat(cli::col_red("\nCe tableau pr√©sente les cryptomonnaies ayant subi les plus fortes baisses sur les derni√®res 24 heures.\n\n"))
  
  # Signaux Haussiers (Top 10)
  display_table_fixed_colored(
    cleaned_data %>% arrange(desc(as.numeric(gsub("%", "", price_change_percentage_24h)))) %>% head(10),
    "Tableau des Signaux Haussiers (Top 10)"
  )
  cat(cli::col_green("\nLes 10 cryptomonnaies les plus performantes √† surveiller.\n\n"))
  
  # Signaux Baissiers (Top 10)
  display_table_fixed_colored(
    cleaned_data %>% arrange(as.numeric(gsub("%", "", price_change_percentage_24h))) %>% head(10),
    "Tableau des Signaux Baissiers (Top 10)"
  )
  cat(cli::col_red("\nLes 10 cryptomonnaies ayant subi les plus fortes baisses.\n"))
  
}


###############################################################################
##### 3 VOLUME ET TRADING
###############################################################################

# Fonction pour formater les grands nombres avec des espaces
format_number <- function(number) {
  # Conversion en milliards
  number_in_billions <- number / 1000000000
  # Formatage avec 2 d√©cimales
  formatted <- sprintf("%.2f", number_in_billions)
  # Ajout des espaces pour les milliers
  parts <- strsplit(formatted, "\\.")[[1]]
  whole_part <- parts[1]
  decimal_part <- parts[2]
  whole_part <- format(as.numeric(whole_part), big.mark = " ", scientific = FALSE)
  return(paste0(whole_part, ".", decimal_part))
}

# Fonction modifi√©e pour afficher un tableau avec les nouvelles colonnes
display_volume_table <- function(data, title) {
  # Largeurs fixes pour chaque colonne
  col_widths <- c(40, 15, 15, 15, 10)  # Largeurs ajust√©es pour les nouvelles colonnes
  
  # Fonction pour tronquer ou remplir les colonnes
  format_column <- function(column, width) {
    sapply(column, function(x) {
      x <- substr(x, 1, width)  # Tronque les cha√Ænes trop longues
      sprintf(paste0("%-", width, "s"), x)  # Ajoute des espaces si n√©cessaire
    })
  }
  
  # Formater les en-t√™tes
  header <- sprintf(
    "%-*s | %-*s | %-*s | %-*s | %-*s",
    col_widths[1], "Nom",
    col_widths[2], "Symbole",
    col_widths[3], "Volume (B$)",
    col_widths[4], "MarketCap (B$)",
    col_widths[5], "Liquidit√© %"
  )
  
  # Formater les donn√©es
  formatted_data <- data.frame(
    Nom = format_column(data$name, col_widths[1]),
    Symbole = format_column(data$symbol, col_widths[2]),
    Volume = format_column(data$volume_formatted, col_widths[3]),
    MarketCap = format_column(data$market_cap_formatted, col_widths[4]),
    Liquidite = format_column(data$liquidity_percentage, col_widths[5])
  )
  
  # Appliquer des couleurs aux donn√©es
  formatted_data$Nom <- cli::col_cyan(formatted_data$Nom)
  formatted_data$Symbole <- cli::col_yellow(formatted_data$Symbole)
  formatted_data$Volume <- cli::col_green(formatted_data$Volume)
  formatted_data$MarketCap <- cli::col_blue(formatted_data$MarketCap)
  formatted_data$Liquidite <- cli::col_magenta(formatted_data$Liquidite)
  
  # Afficher le titre
  cat(cli::col_magenta(title), "\n")
  
  # Afficher les en-t√™tes
  cat(header, "\n")
  
  # Ligne de s√©paration
  cat(paste0(rep("-", sum(col_widths) + 10), collapse = ""), "\n")
  
  # Afficher chaque ligne de donn√©es
  for (i in 1:nrow(formatted_data)) {
    cat(sprintf(
      "%-*s | %-*s | %-*s | %-*s | %-*s\n",
      col_widths[1], formatted_data$Nom[i],
      col_widths[2], formatted_data$Symbole[i],
      col_widths[3], formatted_data$Volume[i],
      col_widths[4], formatted_data$MarketCap[i],
      col_widths[5], formatted_data$Liquidite[i]
    ))
  }
}

# Fonction principale pour analyser les volumes et la liquidit√©
process_volume_trading <- function(data) {
  cat(section_title_style("\n=== Analyse des Volumes et de la Liquidit√© ===\n"))
  
  cat(section_title_style("\nDans cette section, vous trouverez les analyses des volumes de trading et de la liquidit√©"))
  cat(" des cryptomonnaies, bas√©es sur les donn√©es de l'API CoinGecko.\n\n")
  
  cat("Nous vous pr√©senterons :\n")
  cat(info_style(" La relation entre les volumes √©chang√©s et la capitalisation boursi√®re sur 24h\n"))
  cat(info_style(" Les niveau de volumes de trading\n"))  
  cat(info_style(" Les indicateurs cl√©s de liquidit√©\n\n"))
  
  cat(highlight_style("La compr√©hension de ces √©l√©ments est essentielle"))
  cat(info_secondary_style(" pour interpr√©ter l'activit√© du march√©, √©valuer la facilit√© √† acheter ou vendre un actif "))
  cat("et d√©tecter de potentielles anomalies.\n\n")
  
  cat(success_style("Plongeons maintenant dans l'analyse de ces donn√©es de volumes et de liquidit√©."))
  
  if (is.null(data) || nrow(data) == 0) {
    cat(error_style("\nErreur : Les donn√©es ne sont pas disponibles. Veuillez v√©rifier l'appel API.\n"))
    return()
  }
  
  # Pr√©paration et nettoyage des donn√©es
  cleaned_data <- data %>%
    select(name, symbol, total_volume, market_cap) %>%
    mutate(
      # Conversion en milliards avec formatage am√©lior√©
      volume_formatted = sapply(total_volume, format_number),
      market_cap_formatted = sapply(market_cap, format_number),
      # Calcul du ratio de liquidit√© (volume/market_cap en pourcentage)
      liquidity_ratio = (total_volume / market_cap) * 100,
      liquidity_percentage = sprintf("%.2f%%", liquidity_ratio)
    )
  
  # Top 100 par volume
  cat(section_title_style("\n=== Top 100 Cryptomonnaies par Volume de Trading ===\n\n"))
  cat(highlight_style("Analyse des volumes de trading sur 24 heures (exprim√©s en milliards USD) des 100 cryptomonnaies les plus actives selon les donn√©es temps r√©el de CoinGecko. La capitalisation boursi√®re est √©galement exprim√©e en milliards USD pour une √©valuation comparative pr√©cise. Le volume d'√©changes est un indicateur cl√© de la profondeur du march√© et de l'int√©r√™t des traders.\n\n"))
  display_volume_table(
    cleaned_data %>% 
      arrange(desc(total_volume)) %>% 
      head(100),
    "Classement par Volume de Trading (Top 100)"
  )
  
  # Top 50 par liquidit√© (les plus √©lev√©s)
  cat(section_title_style("\n=== Top 50 Cryptomonnaies par Taux de Liquidit√© ===\n\n"))
  cat(highlight_style("Classement des 50 actifs pr√©sentant les meilleurs ratios de liquidit√© (Volume 24h / Market Cap). Ce ratio, exprim√© en pourcentage, est un indicateur crucial de la capacit√© d'un actif √† √™tre √©chang√© sans impact significatif sur son prix. Les volumes et capitalisations sont exprim√©s en milliards USD, donn√©es valid√©es par CoinGecko.\n\n"))
  display_volume_table(
    cleaned_data %>% 
      arrange(desc(liquidity_ratio)) %>% 
      head(50),
    "Classement par Taux de Liquidit√© le Plus √âlev√© (Top 50)"
  )
  
  # Top 50 par liquidit√© (les plus faibles)
  cat(section_title_style("\n=== Top 50 Cryptomonnaies avec le Taux de Liquidit√© le Plus Faible ===\n\n"))
  cat(highlight_style("Identification des 50 actifs pr√©sentant les ratios de liquidit√© (Volume 24h / Market Cap) les plus faibles parmi les principales cryptomonnaies. Un faible ratio peut indiquer une concentration importante des d√©tenteurs ou une faible activit√© de trading. Volumes et capitalisations exprim√©s en milliards USD. Donn√©es fournies en temps r√©el par l'API CoinGecko.\n\n"))
  display_volume_table(
    cleaned_data %>% 
      arrange(liquidity_ratio) %>% 
      head(50),
    "Classement par Taux de Liquidit√© le Plus Faible (Top 50)"
  )
}

###############################################################################
####. Statistiques sociales
###############################################################################

# Fonction pour formater les grands nombres
format_large_number <- function(x) {
  format(x, big.mark = " ", scientific = FALSE)
}

# Fonction pour le formatage des tableaux
display_table_fixed_colored2 <- function(data) {
  # Largeurs fixes pour chaque type de colonne
  col_widths <- c(
    name = 30,
    symbol = 10,
    id = 25,
    market_cap = 20,
    twitter_followers = 20,
    sentiment_votes_up = 20,
    sentiment_votes_down = 20
  )
  
  # Fonction pour formater une colonne
  format_column <- function(values, width) {
    sapply(values, function(x) {
      x <- substr(as.character(x), 1, width)
      sprintf(paste0("%-", width, "s"), x)
    })
  }
  
  # Formater l'en-t√™te
  header_parts <- mapply(function(name, width) {
    sprintf(paste0("%-", width, "s"), toupper(name))
  }, names(data), col_widths[names(data)])
  
  header <- paste(header_parts, collapse = " | ")
  
  # Afficher l'en-t√™te
  cat(cli::col_yellow(header), "\n")
  cat(paste(rep("-", sum(col_widths[names(data)]) + (3 * (ncol(data) - 1))), collapse = ""), "\n")
  
  # Formater et afficher chaque ligne avec des couleurs
  for(i in 1:nrow(data)) {
    row_values <- mapply(function(value, col_name, width) {
      formatted <- format_column(value, width)
      switch(col_name,
             "name" = cli::col_cyan(formatted),
             "symbol" = cli::col_green(formatted),
             "id" = cli::col_magenta(formatted),
             "market_cap" = cli::col_yellow(formatted),
             "twitter_followers" = cli::col_blue(formatted),
             "sentiment_votes_up" = cli::col_green(formatted),
             "sentiment_votes_down" = cli::col_red(formatted),
             formatted)
    }, as.list(data[i,]), names(data), col_widths[names(data)])
    
    cat(paste(row_values, collapse = " | "), "\n")
  }
  cat("\n")
}

# Fonction pour t√©l√©charger les 250 premi√®res cryptos
get_top_cryptos <- function() {
  url <- "https://api.coingecko.com/api/v3/coins/markets"
  params <- list(
    vs_currency = "usd",
    order = "market_cap_desc",
    per_page = 250,
    page = 1,
    sparkline = FALSE
  )
  
  response <- GET(url, query = params)
  
  if (status_code(response) == 200) {
    data <- fromJSON(content(response, "text", encoding = "UTF-8"))
    cat(success_style("\nDonn√©es des 250 premi√®res cryptos t√©l√©charg√©es avec succ√®s !\n\n"))
    return(data)
  } else {
    cat(error_style("\nErreur lors de la r√©cup√©ration des donn√©es.\n"))
    return(NULL)
  }
}

# Fonction pour t√©l√©charger les donn√©es sociales
get_social_data <- function(id) {
  url <- paste0("https://api.coingecko.com/api/v3/coins/", id)
  response <- GET(url)
  
  if (status_code(response) == 200) {
    data <- fromJSON(content(response, "text", encoding = "UTF-8"))
    return(data)
  } else if (status_code(response) == 429) {
    cat(warning_style("\nLimite atteinte pour ", id, ". Pause de 61 secondes...\n"))
    Sys.sleep(61)
    return(NULL)
  } else {
    cat(error_style(paste0("\nErreur lors de la r√©cup√©ration des donn√©es pour ", id, "\n")))
    return(NULL)
  }
}

# Menu principal
social_main_menu <- function() {
  repeat {
    cat(section_title_style("\n Options - Social Metrics des Cryptos\n\n"))
    cat(question_style("0) Revenir au menu pr√©c√©dent\n"))
    cat("1) Visualiser les socials metrics sociales d'une crypto sp√©cifique\n")
    cat("2) Visualiser les socials metrics du march√© crypto en g√©n√©ral\n")
    
    # Lecture et validation de l'entr√©e utilisateur
    repeat {
      choix <- suppressWarnings(as.integer(readline(question_style("\nVeuillez entrer votre choix (0, 1 ou 2) : "))))
      
      # V√©rification si choix est NA ou hors limites
      if (!is.na(choix) && choix >= 0 && choix <= 2) {
        break
      }
      cat(warning_style("\nChoix invalide. Veuillez entrer 0, 1 ou 2 uniquement.\n"))
    }
    
    if (choix == 0) {
      cat(info_style("\nRetour au menu pr√©c√©dent...\n"))
      break
    } else if (choix == 1) {
      visualiser_crypto_specifique()
    } else if (choix == 2) {
      visualiser_cryptos_generales()
    }
  }
}

# Visualisation d'une crypto sp√©cifique
visualiser_crypto_specifique <- function() {
  cat(section_title_style("\nVisualisation des socials metrics d'une crypto sp√©cifique\n"))
  
  repeat {
    connait_id <- tolower(readline(question_style("Connaissez-vous l'ID de la crypto ? (oui/non) : ")))
    if (connait_id %in% c("oui", "non")) break
    cat(warning_style("\nVeuillez r√©pondre uniquement par 'oui' ou 'non'.\n"))
  }
  
  if (connait_id == "oui") {
    repeat {
      id <- readline(question_style("Veuillez entrer l'ID de la crypto : "))
      social_data <- get_social_data(id)
      
      if (!is.null(social_data)) {
        cat(success_style("\nDonn√©es pour ", id, " t√©l√©charg√©es avec succ√®s !\n\n"))
        
        # Cr√©ation d'un tableau format√©
        result_df <- data.frame(
          name = social_data$name,
          symbol = social_data$symbol,
          twitter_followers = format_large_number(social_data$community_data$twitter_followers),
          sentiment_votes_up = paste0(round(social_data$sentiment_votes_up_percentage, 2), "%"),
          sentiment_votes_down = paste0(round(social_data$sentiment_votes_down_percentage, 2), "%"),
          stringsAsFactors = FALSE
        )
        
        display_table_fixed_colored2(result_df)
        
        # Analyse du sentiment
        mood_global <- social_data$sentiment_votes_up_percentage
        cat(section_title_style("Analyse du Sentiment :\n\n"))
        cat("Mood Global : ", highlight_style(paste0(round(mood_global, 2), "%\n\n")))
        
        sentiment_message <- if (mood_global > 70) {
          success_style("Le sentiment est hyper positif - Bull Market en vue ! üöÄ")
        } else if (mood_global > 50) {
          success_style("Le sentiment est globalement positif üìà")
        } else if (mood_global > 30) {
          warning_style("Le sentiment est globalement n√©gatif üìâ")
        } else {
          error_style("Le sentiment est hyper n√©gatif - Bear Market en vue ! üêª")
        }
        
        cat(sentiment_message, "\n\n")
        break
      } else {
        cat(warning_style("\nID invalide ou probl√®me lors de la r√©cup√©ration. Veuillez r√©essayer.\n"))
      }
    }
  } else {
    top_cryptos <- get_top_cryptos()
    if (!is.null(top_cryptos)) {
      display_df <- top_cryptos %>% 
        select(name, id, market_cap) %>%
        head(250) %>%
        mutate(market_cap = paste0(format_large_number(round(market_cap / 1e9, 2)), " Mds $"))
      
      cat(section_title_style("\nListe des 250 plus grandes cryptos :\n\n"))
      display_table_fixed_colored2(display_df)
      readline(info_style("Veuillez noter l'ID qui vous int√©resse et appuyer sur Entr√©e pour continuer...\n"))
      visualiser_crypto_specifique()
    }
  }
}

# Visualisation des cryptos en g√©n√©ral
visualiser_cryptos_generales <- function() {
  repeat {
    cat(section_title_style("\nVisualisation des sociales metrics des cryptos\n\n"))
    cat(question_style("0) Retour au menu principal\n"))
    cat("1) Visualiser les 4 plus grandes cryptos (", warning_style("Temps d'attente: < 60 secondes"), ")\n")
    cat("2) Visualiser les 8 plus grandes cryptos (", warning_style("temps d'attente estim√© : 2 minutes"), ")\n")
    cat("3) Visualiser les 12 plus grandes cryptos (", warning_style("temps d'attente estim√© : 3 minutes"), ")\n")
    cat("4) Visualiser les 16 plus grandes cryptos (", warning_style("temps d'attente estim√© : 4 minutes"), ")\n")
    cat("5) Choisir un nombre personnalis√© de cryptos (", warning_style("Maximum 50"), ")\n")
    
    # Lecture et validation de l'entr√©e utilisateur
    repeat {
      choix <- suppressWarnings(as.integer(readline(question_style("\nVeuillez entrer votre choix (0-5) : "))))
      
      # V√©rification si choix est NA ou hors limites
      if (!is.na(choix) && choix >= 0 && choix <= 5) {
        break
      }
      cat(warning_style("\nChoix invalide. Veuillez entrer un nombre entre 0 et 5.\n"))
    }
    
    if (choix == 0) {
      cat(info_style("\nRetour au menu principal...\n"))
      break
    } else if (choix == 5) {
      # Gestion du nombre personnalis√©
      repeat {
        nombre_perso <- suppressWarnings(as.integer(readline(question_style("\nEntrez le nombre de cryptos √† visualiser (maximum 50) : "))))
        
        if (!is.na(nombre_perso) && nombre_perso > 0 && nombre_perso <= 50) {
          temps_estime <- ceiling(nombre_perso / 4) * 1.5
          cat(warning_style(paste0("\nTemps d'attente estim√© : ", temps_estime, " minutes\n")))
          
          repeat {
            choix_confirme <- tolower(readline(question_style("Voulez-vous continuer ? (oui/non) : ")))
            if (choix_confirme %in% c("oui", "non")) break
            cat(warning_style("\nVeuillez r√©pondre uniquement par 'oui' ou 'non'.\n"))
          }
          
          if (choix_confirme == "oui") {
            top_cryptos <- get_top_cryptos()
            if (!is.null(top_cryptos)) {
              top_ids <- head(top_cryptos$id, nombre_perso)
              afficher_social_metrics(top_ids)
            }
          }
          break
        } else {
          cat(warning_style("\nNombre invalide. Veuillez entrer un nombre entre 1 et 50.\n"))
        }
      }
    } else if (choix >= 1 && choix <= 4) {
      nombre_cryptos <- choix * 4
      top_cryptos <- get_top_cryptos()
      if (!is.null(top_cryptos)) {
        top_ids <- head(top_cryptos$id, nombre_cryptos)
        afficher_social_metrics(top_ids)
      }
    }
  }
}

# Affichage des metrics sociales
afficher_social_metrics <- function(ids) {
  social_data_list <- list()
  sentiment_votes_raw <- numeric()  # Pour stocker les valeurs brutes des sentiments
  
  for (i in seq_along(ids)) {
    id <- ids[i]
    cat(info_style(paste0("\nT√©l√©chargement des donn√©es pour : ", id, "...\n")))
    
    social_data <- get_social_data(id)
    
    if (!is.null(social_data)) {
      sentiment_votes_raw <- c(sentiment_votes_raw, social_data$sentiment_votes_up_percentage)
      
      social_data_list[[i]] <- data.frame(
        name = social_data$name,
        symbol = social_data$symbol,
        twitter_followers = format_large_number(social_data$community_data$twitter_followers),
        sentiment_votes_up = paste0(round(social_data$sentiment_votes_up_percentage, 2), "%"),
        sentiment_votes_down = paste0(round(social_data$sentiment_votes_down_percentage, 2), "%"),
        stringsAsFactors = FALSE
      )
    }
    
    if (i %% 4 == 0 && i < length(ids)) {
      cat(warning_style("\nPause de 61 secondes pour respecter les limites de l'API...\n"))
      Sys.sleep(61)
    } else {
      Sys.sleep(2)
    }
  }
  
  cat("\nR√©sultats :\n\n")
  social_data_table <- do.call(rbind, social_data_list)
  display_table_fixed_colored2(social_data_table)
  
  # Calcul et affichage du sentiment global
  mood_global <- mean(sentiment_votes_raw)
  cat(section_title_style("Analyse du Sentiment Global :\n\n"))
  cat("Mood Global : ", highlight_style(paste0(round(mood_global, 2), "%\n\n")))
  
  # Analyse du sentiment
  sentiment_message <- if (mood_global > 70) {
    success_style("Le sentiment est hyper positif - Bull Market en vue ! üöÄ")
  } else if (mood_global > 50) {
    success_style("Le sentiment est globalement positif üìà")
  } else if (mood_global > 30) {
    warning_style("Le sentiment est globalement n√©gatif üìâ")
  } else {
    error_style("Le sentiment est hyper n√©gatif - Bear Market en vue ! üêª")
  }
  
  cat(sentiment_message, "\n\n")
}

# Ex√©cution du menu principal

###############################################################################@
######## TREND ANALYSIS
################################################################################

# Fonction am√©lior√©e pour formater les grands nombres
format_large_number <- function(x) {
  sapply(x, function(value) {
    if (is.na(value)) {
      "N/A"
    } else {
      format(value, big.mark = " ", scientific = FALSE)
    }
  })
}

display_table_fixed_colored_generique <- function(data, title = NULL) {
  data <- as.data.frame(lapply(data, function(x) {
    ifelse(is.na(x), "N/A", x)
  }))
  
  col_widths <- c(
    rank = 5,
    name = 40,
    symbol = 10,
    score = 10,
    market_cap_rank = 15,
    price_change = 15,
    market_cap = 20
  )
  
  format_column <- function(values, width) {
    sapply(values, function(x) {
      x <- substr(as.character(x), 1, width)
      sprintf(paste0("%-", width, "s"), x)
    })
  }
  
  if (!is.null(title)) {
    cat(section_title_style(paste0("\n", title, "\n\n")))
  }
  
  header_parts <- mapply(function(name, width) {
    if (is.na(width)) {
      toupper(name)
    } else {
      sprintf(paste0("%-", width, "s"), toupper(name))
    }
  }, names(data), col_widths[names(data)])
  
  header <- paste(header_parts, collapse = " | ")
  cat(cli::col_yellow(header), "\n")
  cat(paste(rep("-", nchar(header)), collapse = ""), "\n")
  
  for (i in 1:nrow(data)) {
    row_values <- mapply(function(value, col_name, width) {
      formatted <- format_column(value, width)
      switch(col_name,
             "name" = cli::col_cyan(formatted),
             "symbol" = cli::col_green(formatted),
             "score" = cli::col_yellow(formatted),
             "market_cap_rank" = cli::col_magenta(formatted),
             "price_change" = {
               if (value == "N/A") {
                 formatted
               } else {
                 value <- as.numeric(gsub("%", "", value))
                 if (value >= 0) cli::col_green(formatted) else cli::col_red(formatted)
               }
             },
             formatted)
    }, as.list(data[i,]), names(data), col_widths[names(data)])
    
    cat(paste(row_values, collapse = " | "), "\n")
  }
  cat("\n")
}

##################
display_table_fixed_colored_option4 <- function(data, title = NULL) {
  data <- as.data.frame(lapply(data, function(x) as.character(x)))
  data[is.na(data)] <- "N/A"
  
  col_widths <- c(
    name = 40,
    market_cap = 20,
    change_24h = 15
  )
  
  format_column <- function(values, width) {
    sapply(values, function(x) {
      x <- substr(as.character(x), 1, width)
      sprintf(paste0("%-", width, "s"), x)
    })
  }
  
  if (!is.null(title)) {
    cat(section_title_style(paste0("\n", title, "\n\n")))
  }
  
  header_parts <- mapply(function(name, width) {
    sprintf(paste0("%-", width, "s"), toupper(name))
  }, names(data), col_widths[names(data)])
  
  header <- paste(header_parts, collapse = " | ")
  cat(cli::col_yellow(header), "\n")
  cat(paste(rep("-", nchar(header)), collapse = ""), "\n")
  
  for (i in 1:nrow(data)) {
    row_values <- mapply(function(value, col_name, width) {
      formatted <- format_column(value, width)
      switch(col_name,
             "name" = cli::col_cyan(formatted),
             "market_cap" = cli::col_green(formatted),
             "change_24h" = {
               value <- as.numeric(gsub("%", "", value))
               if (is.na(value)) cli::col_yellow(formatted)
               else if (value >= 0) cli::col_green(formatted) else cli::col_red(formatted)
             },
             formatted)
    }, as.list(data[i,]), names(data), col_widths[names(data)])
    
    cat(paste(row_values, collapse = " | "), "\n")
  }
  cat("\n")
}

# Fonction pour r√©cup√©rer les tendances
get_trends <- function() {
  tryCatch({
    response <- GET("https://api.coingecko.com/api/v3/search/trending")
    
    if (status_code(response) == 200) {
      data <- fromJSON(rawToChar(response$content))
      return(data)
    } else {
      cat(error_style("\nErreur lors de la r√©cup√©ration des tendances. Code:", status_code(response), "\n"))
      return(NULL)
    }
  }, error = function(e) {
    cat(error_style("\nErreur de connexion √† l'API:", e$message, "\n"))
    return(NULL)
  })
}

# Fonction pour obtenir les informations d'une crypto sp√©cifique
get_coin_info <- function(id) {
  tryCatch({
    response <- GET(paste0("https://api.coingecko.com/api/v3/coins/", id))
    
    if (status_code(response) == 200) {
      data <- fromJSON(rawToChar(response$content))
      return(data)
    } else {
      cat(error_style("\nErreur lors de la r√©cup√©ration des informations. Code:", status_code(response), "\n"))
      return(NULL)
    }
  }, error = function(e) {
    cat(error_style("\nErreur de connexion √† l'API:", e$message, "\n"))
    return(NULL)
  })
}

# Fonction pour obtenir les cat√©gories
get_categories <- function() {
  tryCatch({
    response <- GET("https://api.coingecko.com/api/v3/coins/categories")
    
    if (status_code(response) == 200) {
      data <- fromJSON(rawToChar(response$content))
      return(data)
    } else {
      cat(error_style("\nErreur lors de la r√©cup√©ration des cat√©gories. Code:", status_code(response), "\n"))
      return(NULL)
    }
  }, error = function(e) {
    cat(error_style("\nErreur de connexion √† l'API:", e$message, "\n"))
    return(NULL)
  })
}

#######################################
# Fonction pour l'analyse des tendances (Option 1)
analyze_trends <- function() {
  cat(section_title_style("\n=== Analyse des Tendances de Recherche ===\n\n"))
  
  # Texte explicatif
  cat(info_style("Cette section vous pr√©sente les cryptomonnaies et NFTs actuellement en tendance sur CoinGecko.\n\n"))
  cat(info_style("Les donn√©es affich√©es sont bas√©es sur :\n"))
  cat(info_style("- Le volume de recherches effectu√©es par les utilisateurs sur CoinGecko.\n"))
  cat(info_style("- Les interactions des utilisateurs sur des plateformes sociales comme Twitter et Reddit.\n\n"))
  cat(info_style("Ces tendances sont calcul√©es sur une p√©riode r√©cente (souvent quelques jours √† une semaine)\n"))
  cat(info_style("et sont mises √† jour r√©guli√®rement pour refl√©ter les changements d'int√©r√™t des utilisateurs.\n\n"))
  cat(success_style("Vous trouverez ci-dessous les actifs les plus populaires, class√©s par recherche et int√©r√™t :\n\n"))
  
  trends_data <- get_trends()
  if (!is.null(trends_data)) {
    # Cryptos en tendance
    crypto_trends <- data.frame(
      name = trends_data$coins$item$name,
      symbol = toupper(trends_data$coins$item$symbol)
    )
    
    cat(success_style("\nTop Cryptos les plus recherch√©es :\n"))
    display_table_fixed_colored_generique(head(crypto_trends, 100))
    
    # NFTs en tendance
    nft_trends <- data.frame(
      name = trends_data$nfts$name,
      symbol = toupper(trends_data$nfts$symbol)
    )
    
    cat(success_style("\nTop NFTs les plus recherch√©s :\n"))
    display_table_fixed_colored_generique(head(nft_trends, 50))
  }
  
  readline(question_style("\nAppuyez sur Entr√©e pour revenir au menu..."))
}

#####################################
# Fonction pour le score de tendance (Option 2)
trend_score_analysis <- function() {
  cat(section_title_style("\n=== Score de Tendance ===\n\n"))
  
  # Explication du score de tendance
  cat(highlight_style("Le score de tendance refl√®te l'int√©r√™t des utilisateurs envers une cryptomonnaie.\n\n"))
  cat(info_style("Ce score est bas√© sur :\n"))
  cat(info_style("- Le volume de recherches et d'interactions sur CoinGecko.\n"))
  cat(info_style("- Les mentions et interactions sur des plateformes sociales comme Twitter et Reddit.\n\n"))
  cat(info_style("La p√©riode d'analyse couvre environ 30 jours. Les donn√©es sont mises √† jour\n"))
  cat(info_style("r√©guli√®rement pour refl√©ter les tendances actuelles.\n\n"))
  cat(info_style("Contrairement aux variations de prix ou √† la capitalisation, ce score mesure\n"))
  cat(info_style("l'int√©r√™t global et non financier envers une cryptomonnaie donn√©e.\n\n"))
  
  # Lecture du score
  cat(success_style("Lecture du score :\n"))
  cat(info_style("- Un score √©lev√© (par exemple, 15-20) indique une forte popularit√© r√©cente.\n"))
  cat(info_style("- Un score de 0 signifie un int√©r√™t tr√®s faible ou inexistant.\n"))
  cat(info_style("- La plage des scores observ√©s varie g√©n√©ralement entre 0 et environ 15-20,\n"))
  cat(info_style("  mais elle n'a pas de limite fixe sup√©rieure.\n\n"))
  
  cat(success_style("Les cryptos les plus populaires du moment sont affich√©es ci-dessous :\n\n"))
  
  trends_data <- get_trends()
  if (!is.null(trends_data)) {
    # Construction des donn√©es pour le tableau
    trend_scores <- data.frame(
      name = trends_data$coins$item$name,
      symbol = toupper(trends_data$coins$item$symbol),
      market_cap_rank = trends_data$coins$item$market_cap_rank,
      score = trends_data$coins$item$score
    )
    
    # Tri des cryptos par score d√©croissant
    trend_scores <- trend_scores %>%
      arrange(desc(score))
    
    # Augmentation de la limite d'affichage (affiche tout ce qui est disponible)
    cat(success_style("Classement par popularit√© :\n"))
    display_table_fixed_colored_generique(head(trend_scores, 100))
  } else {
    cat(error_style("\nImpossible de r√©cup√©rer les tendances actuellement. Veuillez r√©essayer plus tard.\n"))
  }
  
  readline(question_style("\nAppuyez sur Entr√©e pour revenir au menu..."))
}


####################################################
# Fonction pour afficher les cryptos disponibles
show_available_coins <- function() {
  cat(section_title_style("\nListe des Cryptos Disponibles\n"))
  
  # Faire la requ√™te pour obtenir la liste des cryptos
  tryCatch({
    response <- GET("https://api.coingecko.com/api/v3/coins/list")
    
    if (status_code(response) == 200) {
      coins <- fromJSON(rawToChar(response$content))
      
      # Cr√©ation du dataframe pour l'affichage
      coins_df <- data.frame(
        name = coins$name,
        symbol = toupper(coins$symbol),
        id = coins$id
      )
      
      # Affichage pagin√© (20 par page)
      total_pages <- ceiling(nrow(coins_df) / 20)
      page <- 1
      
      repeat {
        # Afficher la page courante
        start_idx <- ((page - 1) * 20) + 1
        end_idx <- min(page * 20, nrow(coins_df))
        current_page <- coins_df[start_idx:end_idx, ]
        
        cat(section_title_style(sprintf("\nPage %d/%d\n\n", page, total_pages)))
        display_table_fixed_colored_generique(current_page)
        
        # Options de navigation
        cat(question_style("\nOptions :\n"))
        cat("1) Page suivante\n")
        cat("2) Page pr√©c√©dente\n")
        cat("3) Aller √† une page sp√©cifique\n")
        cat("4) Rechercher par nom\n")
        cat("0) Retour au menu pr√©c√©dent\n")
        
        choix <- suppressWarnings(as.integer(readline(question_style("\nVotre choix : "))))
        
        if (is.na(choix)) next
        
        if (choix == 0) break
        
        switch(choix,
               "1" = {
                 if (page < total_pages) page <- page + 1
                 else cat(warning_style("\nVous √™tes d√©j√† √† la derni√®re page.\n"))
               },
               "2" = {
                 if (page > 1) page <- page - 1
                 else cat(warning_style("\nVous √™tes d√©j√† √† la premi√®re page.\n"))
               },
               "3" = {
                 new_page <- suppressWarnings(as.integer(readline(question_style(
                   sprintf("\nEntrez le num√©ro de page (1-%d) : ", total_pages)))))
                 if (!is.na(new_page) && new_page >= 1 && new_page <= total_pages) {
                   page <- new_page
                 } else {
                   cat(warning_style("\nNum√©ro de page invalide.\n"))
                 }
               },
               "4" = {
                 search_term <- tolower(readline(question_style("\nEntrez le terme √† rechercher : ")))
                 found_coins <- coins_df[grep(search_term, tolower(coins_df$name)), ]
                 
                 if (nrow(found_coins) > 0) {
                   cat(success_style("\nR√©sultats de la recherche :\n"))
                   display_table_fixed_colored_generique(head(found_coins, 20))
                   readline(question_style("\nAppuyez sur Entr√©e pour continuer..."))
                 } else {
                   cat(warning_style("\nAucune crypto trouv√©e avec ce terme.\n"))
                 }
               })
      }
      
    } else {
      cat(error_style("\nErreur lors de la r√©cup√©ration de la liste. Code:", status_code(response), "\n"))
    }
  }, error = function(e) {
    cat(error_style("\nErreur de connexion √† l'API:", e$message, "\n"))
  })
}

# Fonction pour afficher les informations d√©taill√©es d'une crypto
display_coin_info <- function(coin_data) {
  cat(section_title_style(paste("\nInformations d√©taill√©es pour", coin_data$name, "\n")))
  
  # Informations de base
  cat(success_style("\n=== Informations de Base ===\n"))
  cat(info_style("Nom: "), coin_data$name, "\n")
  cat(info_style("Symbole: "), toupper(coin_data$symbol), "\n")
  cat(info_style("Rang Market Cap: "), coin_data$market_cap_rank, "\n")
  
  # Prix et variations
  cat(success_style("\n=== Prix et Variations ===\n"))
  if (!is.null(coin_data$market_data)) {
    cat(info_style("Prix actuel (USD): $"), format(coin_data$market_data$current_price$usd, scientific = FALSE), "\n")
    cat(info_style("Variation 24h: "), 
        ifelse(coin_data$market_data$price_change_percentage_24h >= 0,
               success_style(paste0("+", round(coin_data$market_data$price_change_percentage_24h, 2), "%")),
               warning_style(paste0(round(coin_data$market_data$price_change_percentage_24h, 2), "%"))), "\n")
  }
  
  # Capitalisation
  if (!is.null(coin_data$market_data$market_cap)) {
    cat(success_style("\n=== Capitalisation ===\n"))
    cat(info_style("Market Cap (USD): $"), format_large_number(coin_data$market_data$market_cap$usd), "\n")
    cat(info_style("Volume 24h (USD): $"), format_large_number(coin_data$market_data$total_volume$usd), "\n")
  }
  
  # Donn√©es sociales
  if (!is.null(coin_data$community_data)) {
    cat(success_style("\n=== M√©triques Sociales ===\n"))
    cat(info_style("Twitter Followers: "), format_large_number(coin_data$community_data$twitter_followers), "\n")
    if (!is.null(coin_data$community_data$reddit_subscribers)) {
      cat(info_style("Reddit Subscribers: "), format_large_number(coin_data$community_data$reddit_subscribers), "\n")
    }
  }
  
  # Description
  if (!is.null(coin_data$description$en)) {
    cat(success_style("\n=== Description ===\n"))
    cat(info_style(coin_data$description$en), "\n")
  }
  
  readline(question_style("\nAppuyez sur Entr√©e pour continuer..."))
}

##########################################################
# Fonction pour les informations sur les projets (Option 3)
project_information <- function() {
  cat(section_title_style("\n=== Informations sur les Projets ===\n\n"))
  
  # Texte introductif
  cat(highlight_style("Cette section vous permet d'explorer des informations d√©taill√©es sur les projets des cryptomonnaies disponibles.\n\n"))
  cat(info_style("Vous pouvez :\n"))
  cat(info_style("- Rechercher des d√©tails sur les projets d'une cryptomonnaie sp√©cifique en entrant son ID ou son nom.\n"))
  cat(info_style("- Explorer les 15 projets les plus populaires et en tendance actuellement.\n"))
  cat(info_style("- Parcourir les cryptos disponibles dans des cat√©gories sp√©cifiques comme DeFi, NFT, Gaming, etc.\n\n"))
  cat(success_style("Les donn√©es affich√©es incluent les noms, symboles, prix, variations, rangs de capitalisation et bien plus encore !\n\n"))
  
  
  repeat {
    cat(section_title_style("\n=== Informations sur les Projets ===\n\n"))
    cat(question_style("1) Rechercher une crypto sp√©cifique\n"))
    cat("2) Voir le top 15 des projets en tendance\n")
    cat("3) Rechercher par cat√©gorie\n")
    cat(question_style("0) Retour au menu principal\n"))
    
    choix <- suppressWarnings(as.integer(readline(question_style("\nVotre choix (0-3) : "))))
    
    if (is.na(choix) || choix < 0 || choix > 3) {
      cat(warning_style("\nChoix invalide. Veuillez r√©essayer.\n"))
      next
    }
    
    if (choix == 0) break
    
    switch(choix,
           "1" = search_specific_crypto(),
           "2" = show_top_15_projects(),
           "3" = search_by_category())
  }
}

# Sous-fonctions pour l'option 3
search_specific_crypto <- function() {
  repeat {
    cat(section_title_style("\nRecherche d'une Crypto Sp√©cifique\n"))
    connait_id <- tolower(readline(question_style("\nConnaissez-vous l'ID de la crypto ? (oui/non) : ")))
    
    if (connait_id %in% c("oui", "non")) {
      if (connait_id == "oui") {
        id <- readline(question_style("Entrez l'ID de la crypto : "))
        coin_data <- get_coin_info(id)
        
        if (!is.null(coin_data)) {
          display_coin_info(coin_data)
        }
      } else {
        show_available_coins()
      }
      break
    }
    
    cat(warning_style("\nVeuillez r√©pondre par 'oui' ou 'non'.\n"))
  }
}

##############
show_top_15_projects <- function() {
  cat(section_title_style("\n=== Top 15 Projets en Tendance ===\n\n"))
  
  # Texte explicatif
  cat(highlight_style("Ce classement refl√®te les cryptomonnaies actuellement en tendance sur CoinGecko.\n\n"))
  cat(info_style("Les tendances sont calcul√©es en fonction de :\n"))
  cat(info_style("- Le volume de recherches des utilisateurs sur CoinGecko.\n"))
  cat(info_style("- Les interactions sur des plateformes sociales comme Twitter et Reddit.\n"))
  cat(info_style("- L'engagement global des utilisateurs (listes de favoris, consultations fr√©quentes).\n\n"))
  cat(info_style("Ce classement est dynamique et se concentre sur l'int√©r√™t r√©cent, souvent sur les 7 derniers jours.\n"))
  cat(info_style("Les cryptomonnaies affich√©es peuvent inclure des projets √©mergents ou moins connus,\n"))
  cat(info_style("attirant soudainement l'attention des utilisateurs.\n\n"))
  cat(success_style("Vous trouverez ci-dessous les 15 projets les plus populaires actuellement :\n\n"))
  
  # R√©cup√©ration des tendances
  trends_data <- get_trends()
  if (!is.null(trends_data)) {
    # Construction du tableau avec des informations suppl√©mentaires
    trending_projects <- data.frame(
      name = trends_data$coins$item$name,
      symbol = toupper(trends_data$coins$item$symbol),
      market_cap_rank = trends_data$coins$item$market_cap_rank,
      url = paste0("https://www.coingecko.com/en/coins/", trends_data$coins$item$id) # G√©n√©ration de l'URL
    )
    
    # Affichage des r√©sultats
    for (i in 1:min(15, nrow(trending_projects))) {
      project <- trending_projects[i, ]
      cat(success_style(paste0("\n", i, ". ", project$name, " (", project$symbol, ")\n")))
      cat(info_style("   Rang Market Cap : ", project$market_cap_rank, "\n"))
      cat(info_style("   URL du Projet : ", project$url, "\n"))
      
      # Appel de l'API pour r√©cup√©rer les d√©tails du projet avec gestion des erreurs
      details <- tryCatch({
        get_coin_info(trends_data$coins$item$id[i])
      }, error = function(e) {
        NULL
      })
      
      if (!is.null(details)) {
        # Extraction de la capitalisation boursi√®re
        market_cap_billion <- ifelse(!is.null(details$market_data$market_cap$usd), 
                                     details$market_data$market_cap$usd / 1e9, NA)
        
        # Formatage des nombres
        formatted_market_cap <- ifelse(!is.na(market_cap_billion), 
                                       paste0(format(round(market_cap_billion, 2), big.mark = " "), " Mds $"), 
                                       "N/A")
        
        # Affichage des donn√©es suppl√©mentaires
        cat(info_style("   Capitalisation : ", formatted_market_cap, "\n"))
      } else {
        cat(warning_style("   Impossible de r√©cup√©rer les d√©tails suppl√©mentaires.\n"))
      }
      
      # Pause de 1 seconde entre les requ√™tes pour limiter le d√©bit
      Sys.sleep(1)
    }
  } else {
    cat(warning_style("\nAucune donn√©e disponible pour les projets en tendance.\n"))
  }
}


#########################

search_by_category <- function() {
  categories <- get_categories()
  if (!is.null(categories)) {
    cat(section_title_style("\nCat√©gories Disponibles\n\n"))
    
    for (i in 1:length(categories$name)) {
      cat(sprintf("%d) %s\n", i, categories$name[i]))
    }
    
    cat(question_style("\n0) Retour\n"))
    
    choix <- suppressWarnings(as.integer(readline(question_style("\nChoisissez une cat√©gorie (0-", length(categories$name), ") : "))))
    
    if (!is.na(choix) && choix > 0 && choix <= length(categories$name)) {
      show_category_projects(categories$id[choix])
    }
  }
}

# Fonction pour afficher les projets d'une cat√©gorie
show_category_projects <- function(category_id) {
  tryCatch({
    url <- paste0("https://api.coingecko.com/api/v3/coins/markets")
    params <- list(
      vs_currency = "usd",
      category = category_id,
      order = "market_cap_desc",
      per_page = 50,
      page = 1,
      sparkline = FALSE
    )
    
    response <- GET(url, query = params)
    
    if (status_code(response) == 200) {
      data <- fromJSON(rawToChar(response$content))
      
      if (length(data) > 0) {
        projects_df <- data.frame(
          name = data$name,
          symbol = toupper(data$symbol),
          market_cap = format_large_number(data$market_cap),
          price_change = paste0(round(data$price_change_percentage_24h, 2), "%")
        )
        
        cat(section_title_style(paste("\nProjets dans la cat√©gorie :", category_id, "\n")))
        display_table_fixed_colored_generique(projects_df)
        
        # Options pour voir plus de d√©tails
        repeat {
          cat(question_style("\nOptions :\n"))
          cat("1) Voir les d√©tails d'un projet\n")
          cat("0) Retour\n")
          
          choix <- suppressWarnings(as.integer(readline(question_style("\nVotre choix (0-1) : "))))
          
          if (is.na(choix) || choix < 0 || choix > 1) {
            cat(warning_style("\nChoix invalide.\n"))
            next
          }
          
          if (choix == 0) break
          
          if (choix == 1) {
            project_id <- readline(question_style("\nEntrez l'ID du projet √† consulter : "))
            coin_data <- get_coin_info(project_id)
            if (!is.null(coin_data)) {
              display_coin_info(coin_data)
            }
          }
        }
      } else {
        cat(warning_style("\nAucun projet trouv√© dans cette cat√©gorie.\n"))
      }
    } else {
      cat(error_style("\nErreur lors de la r√©cup√©ration des projets. Code:", status_code(response), "\n"))
    }
  }, error = function(e) {
    cat(error_style("\nErreur lors de la r√©cup√©ration des projets:", e$message, "\n"))
  })
}

#################################################################
## Fonction pour l'analyse des cat√©gories (Option 4)
category_analysis <- function() {
  cat(section_title_style("\n=== Analyse des Cat√©gories et Secteurs ===\n\n"))
  cat(highlight_style("Cette section explore les dynamiques des diff√©rentes cat√©gories de cryptomonnaies.\n\n"))
  cat(info_style("Les cat√©gories regroupent les projets selon leur utilit√©, √©cosyst√®me ou secteur d'activit√©.\n"))
  cat(info_style("Les donn√©es affich√©es incluent :\n"))
  cat(info_style("- Le nom de chaque cat√©gorie.\n"))
  cat(info_style("- La capitalisation de march√© totale (en milliards de dollars).\n"))
  cat(info_style("- La variation de capitalisation sur 24 heures, exprim√©e en pourcentage.\n\n"))
  cat(info_style("Ces informations sont utiles pour :\n"))
  cat(info_style("- Rep√©rer les secteurs en forte croissance ou en d√©clin.\n"))
  cat(info_style("- Comprendre les tendances g√©n√©rales du march√© crypto.\n"))
  cat(info_style("- D√©couvrir de nouvelles niches et opportunit√©s d'investissement.\n\n"))
  cat(success_style("Les cat√©gories les plus importantes et leurs variations sur 24 heures sont affich√©es ci-dessous :\n"))
  
  categories <- get_categories()
  if (!is.null(categories)) {
    # Vue d'ensemble √©conomique
    cat(success_style("\nVue d'ensemble des cat√©gories :\n"))
    
    # Construction du tableau avec gestion des valeurs NA
    summary_df <- data.frame(
      name = ifelse(is.na(categories$name), "N/A", categories$name),
      market_cap = ifelse(is.na(categories$market_cap), 
                          "N/A", 
                          paste0(format(round(as.numeric(categories$market_cap) / 1e9, 2), big.mark = " "), " Mds $")),
      change_24h = ifelse(is.na(categories$market_cap_change_24h), "N/A", paste0(round(categories$market_cap_change_24h, 2), "%"))
    )
    
    # Limiter l'affichage aux 20 premi√®res cat√©gories
    summary_df <- head(summary_df, 20)
    
    # Affichage du tableau
    display_table_fixed_colored_option4(summary_df, "R√©sum√© des Cat√©gories")
    
    # Cat√©gories en croissance/d√©clin
    top_growing <- head(arrange(summary_df, desc(as.numeric(gsub("%", "", change_24h)))), 10)
    top_declining <- head(arrange(summary_df, as.numeric(gsub("%", "", change_24h))), 10)
    
    cat(success_style("\nTop 10 Cat√©gories en Croissance :\n"))
    display_table_fixed_colored_option4(top_growing)
    
    cat(warning_style("\nTop 10 Cat√©gories en D√©clin :\n"))
    display_table_fixed_colored_option4(top_declining)
  } else {
    cat(warning_style("\nAucune donn√©e disponible pour les cat√©gories.\n"))
  }
  
  readline(question_style("\nAppuyez sur Entr√©e pour revenir au menu..."))
}


# Fonction pour l'analyse des variations horaires (Option 5)
hot_hour_analysis <- function() {
  cat(section_title_style("\n=== Hot Hour Analysis ===\n\n"))
  cat(highlight_style("Cette section met en √©vidence les plus fortes variations de prix des cryptomonnaies\n"))
  cat(info_style("et des NFTs sur une p√©riode r√©cente (24 heures).\n\n"))
  cat(info_style("Les donn√©es incluent :\n"))
  cat(info_style("- Les cryptomonnaies avec les plus fortes hausses ou baisses de prix.\n"))
  cat(info_style("- Les NFTs avec les variations de prix planchers les plus significatives.\n\n"))
  cat(info_style("Utilit√© de cette analyse :\n"))
  cat(info_style("- Identifier les projets les plus volatils et dynamiques du moment.\n"))
  cat(info_style("- Rep√©rer des opportunit√©s d'investissement ou des points d'entr√©e sur le march√©.\n"))
  cat(info_style("- Suivre les tendances du march√© en temps r√©el.\n\n"))
  cat(success_style("Les cryptomonnaies et NFTs les plus dynamiques des derni√®res 24 heures sont affich√©s ci-dessous :\n\n"))
  
  
  trends_data <- get_trends()
  if (!is.null(trends_data)) {
    # Cryptos
    crypto_changes <- data.frame(
      name = trends_data$coins$item$name,
      symbol = toupper(trends_data$coins$item$symbol),
      price_change = sapply(trends_data$coins$item$data$price_change_percentage_24h$usd, function(x) {
        if (is.null(x) || is.na(x)) {
          "N/A"
        } else {
          paste0(round(as.numeric(x), 2), "%")
        }
      })
    )
    
    # Top 50 hausses
    cat(success_style("\n Top Hausses Cryptos (24h) :\n"))
    valid_changes <- crypto_changes[crypto_changes$price_change != "N/A", ]
    if (nrow(valid_changes) > 0) {
      top_gainers <- head(arrange(valid_changes, desc(as.numeric(gsub("%", "", price_change)))), 50)
      display_table_fixed_colored_generique(top_gainers)
    } else {
      cat(warning_style("Aucune donn√©e de variation disponible.\n"))
    }
    
    # Top 50 baisses
    cat(warning_style("\nTop Baisses Cryptos (24h) :\n"))
    if (nrow(valid_changes) > 0) {
      top_losers <- head(arrange(valid_changes, as.numeric(gsub("%", "", price_change))), 50)
      display_table_fixed_colored_generique(top_losers)
    } else {
      cat(warning_style("Aucune donn√©e de variation disponible.\n"))
    }
    
    # NFTs
    if (length(trends_data$nfts) > 0) {
      nft_changes <- data.frame(
        name = trends_data$nfts$name,
        symbol = toupper(trends_data$nfts$symbol),
        price_change = sapply(trends_data$nfts$floor_price_24h_percentage_change, function(x) {
          if (is.null(x) || is.na(x)) {
            "N/A"
          } else {
            paste0(round(as.numeric(x), 2), "%")
          }
        })
      )
      
      valid_nft_changes <- nft_changes[nft_changes$price_change != "N/A", ]
      
      # Top 10 NFT hausses
      cat(success_style("\nTop NFTs en Hausse :\n"))
      if (nrow(valid_nft_changes) > 0) {
        top_nft_gainers <- head(arrange(valid_nft_changes, desc(as.numeric(gsub("%", "", price_change)))), 10)
        display_table_fixed_colored_generique(top_nft_gainers)
      } else {
        cat(warning_style("Aucune donn√©e de variation disponible.\n"))
      }
      
      # Top 10 NFT baisses
      cat(warning_style("\nTop NFTs en Baisse :\n"))
      if (nrow(valid_nft_changes) > 0) {
        top_nft_losers <- head(arrange(valid_nft_changes, as.numeric(gsub("%", "", price_change))), 10)
        display_table_fixed_colored_generique(top_nft_losers)
      } else {
        cat(warning_style("Aucune donn√©e de variation disponible.\n"))
      }
    }
  }
  
  readline(question_style("\nAppuyez sur Entr√©e pour revenir au menu..."))
}


# Menu 
################################

trend_menu <- function() {
  repeat {
    # Message d'introduction
    cat(section_title_style("\n=== Analyse des Tendances du March√© Crypto ===\n"))
    cat(info_style("\nBienvenue dans l'analyseur de tendances. Cet outil vous permet d'explorer\n"))
    cat(info_style("les tendances actuelles du march√© des cryptomonnaies et des NFTs.\n"))
    
    # Options du menu
    cat(section_title_style("\nOptions Disponibles :\n\n"))
    cat(question_style("0) Retour au menu P√©pite\n"))
    cat("1) Analyse des tendances (Top Cryptos et Top NFTs)\n")
    cat("2) Score de tendance et popularit√©\n")
    cat("3) Information d√©taill√©e sur les projets\n")
    cat("4) Analyse des cat√©gories et secteurs\n")
    cat("5) Hot Hour (Variations horaires)\n")
    
    # Lecture et validation du choix
    repeat {
      choix <- suppressWarnings(as.integer(readline(question_style("\nVeuillez entrer votre choix (0-5) : "))))
      
      if (!is.na(choix) && choix >= 0 && choix <= 5) {
        break
      }
      cat(warning_style("\nChoix invalide. Veuillez entrer un nombre entre 0 et 5.\n"))
    }
    
    # Traitement du choix
    if (choix == 0) {
      cat(info_style("\nRetour au menu P√©pite...\n"))
      break
    }
    
    # Ex√©cution de la fonction correspondante
    switch(choix,
           "1" = analyze_trends(),
           "2" = trend_score_analysis(),
           "3" = project_information(),
           "4" = category_analysis(),
           "5" = hot_hour_analysis())
  }
}

# Ex√©cution du menu principal des tendances




################################################################################
#########                  LUNAR CRUSH (API Payante)
################################################################################

lunar_crush <- function() {
  # Message d'introduction
  cat(section_title_style("\nBienvenue sur LunarCrush - Analyse Crypto avanc√©e !\n"))
  cat(success_style("\n===========================================================\n"))
  cat(highlight_style("LunarCrush est une plateforme innovante qui fournit des analyses approfondies sur les cryptomonnaies. Voici ce qu'elle offre :\n"))
  
  cat(highlight_style("\nAnalyse des tendances sociales :"), 
      info_style("D√©couvrez les cryptomonnaies les plus mentionn√©es sur les r√©seaux sociaux, identifiez les tendances √©mergentes et √©valuez l'int√©r√™t communautaire."), "\n")
  
  cat(highlight_style("\nAnalyse des tendances de recherche :"), 
      info_style("Obtenez un aper√ßu des recherches les plus populaires pour les cryptos sur diverses plateformes."), "\n")
  
  cat(highlight_style("\nAltRank :"), 
      info_style("Classement unique qui combine l'activit√© sociale et les indicateurs de march√© pour √©valuer les opportunit√©s cach√©es."), "\n")
  
  cat(highlight_style("\nGalaxy Score :"), 
      info_style("Un score exclusif bas√© sur une combinaison de donn√©es sociales, de march√© et techniques pour mesurer la sant√© et la qualit√© d'une crypto."), "\n")
  
  cat(success_style("\n===========================================================\n"))
  
  # Message indiquant que l'outil est en pause
  cat(warning_style("\nActuellement, notre outil est en cours de d√©veloppement car l'API LunarCrush n√©cessite un abonnement payant.\n"))
  cat(warning_style("\nLa construction de cet outil est donc temporairement en pause.\n"))
  
  # Menu principal pour LunarCrush
  repeat {
    cat(section_title_style("\n=== Menu LunarCrush ===\n"))
    options <- c(
      question_style("Retour au menu P√©pitesHunter"),
      "Analyse des tendances sociales",
      "Analyse des tendances de recherche",
      "AltRank",
      "Galaxy Score"
    )
    
    for (i in seq_along(options)) {
      cat(paste0(i - 1, ". ", options[i], "\n"))
    }
    
    choix <- readline(question_style("Veuillez choisir une option (par num√©ro) : "))
    
    if (choix == "0") {
      cat(question_style("\nRetour au menu P√©pitesHunter...
"))
      break
    } else if (choix %in% c("1", "2", "3", "4")) {
      option <- options[as.numeric(choix) + 1]
      cat(success_style(paste0("\nVous avez choisi : ", option, "\n")))
      
      # Explication sp√©cifique √† chaque option
      if (option == "Analyse des tendances sociales") {
        cat(info_style("\nL'analyse des tendances sociales vous permet de rep√©rer les cryptomonnaies les plus mentionn√©es sur les r√©seaux sociaux. Ces informations peuvent aider √† identifier des opportunit√©s avant qu'elles ne deviennent mainstream.\n"))
      } else if (option == "Analyse des tendances de recherche") {
        cat(info_style("\nCette option analyse les termes de recherche pour les cryptos, ce qui peut indiquer un int√©r√™t croissant ou une tendance en d√©veloppement.\n"))
      } else if (option == "AltRank") {
        cat(info_style("\nAltRank combine l'activit√© sociale et les indicateurs de march√© pour classer les cryptos, en mettant en lumi√®re celles qui ont un potentiel cach√©.\n"))
      } else if (option == "Galaxy Score") {
        cat(info_style("\nGalaxy Score est un indicateur unique qui √©value la sant√© globale et la qualit√© d'une crypto en fonction de donn√©es sociales, de march√© et techniques.\n"))
      }
      
      # Message indiquant que la fonctionnalit√© est indisponible
      cat(warning_style("\nCette fonctionnalit√© est en cours de construction.\n"))
      cat(warning_style("\nMalheureusement, l'API LunarCrush est payante et n√©cessite un abonnement.\n"))
    } else {
      cat(warning_style("\nChoix invalide. Veuillez s√©lectionner un num√©ro parmi les options disponibles.\n"))
    }
  }
}

# Appel √† la fonction principale



################################################################################
#########                  Santiment (API Payante)
################################################################################

santiment <- function() {
  # Message d'introduction
  cat(section_title_style("\nBienvenue sur Santiment - Analyse Crypto avanc√©e !\n"))
  cat(success_style("\n===========================================================\n"))
  cat(highlight_style("Santiment est une plateforme sp√©cialis√©e dans l'analyse des cryptomonnaies, ax√©e sur quatre types de donn√©es principales :\n"))
  
  cat(highlight_style("\nDonn√©es on-chain :"), 
      info_style("Cela inclut les transactions en temps r√©el, les flux d'√©changes, et les donn√©es blockchain pertinentes. Ces analyses permettent d'identifier les mouvements de \"whales\" (grands d√©tenteurs de crypto) ou des changements inhabituels dans les activit√©s on-chain."), "\n")
  
  cat(highlight_style("\nSignaux sociaux :"), 
      info_style("Analyse des discussions sur les r√©seaux sociaux pour d√©tecter les tendances √©mergentes et les sentiments autour des cryptomonnaies."), "\n")
  
  cat(highlight_style("\nAnalyse de sentiment de march√© :"), 
      info_style("Utilise des m√©triques pour comprendre si le sentiment global des investisseurs est optimiste, pessimiste ou neutre."), "\n")
  
  cat(highlight_style("\nDonn√©es de d√©veloppement :"), 
      info_style("Donn√©es sur l'activit√© des d√©veloppeurs des projets blockchain, incluant les commits GitHub ou l'√©volution des projets techniques."), "\n")
  
  cat(success_style("\n===========================================================\n"))
  
  # Message indiquant que l'outil est en pause
  cat(warning_style("\nActuellement, cet outil est en cours de d√©veloppement car l'API Santiment n√©cessite un abonnement payant.\n"))
  cat(warning_style("\nLa construction de cet outil est donc temporairement en pause.\n"))
  
  # Menu principal pour Santiment
  repeat {
    cat(section_title_style("\n=== Menu Santiment ===\n"))
    options <- c(
      question_style("Retour au menu P√©pitesHunter"),
      "Analyse des donn√©es on-chain",
      "Analyse des signaux sociaux",
      "Analyse du sentiment de march√©",
      "Suivi des donn√©es de d√©veloppement"
    )
    
    for (i in seq_along(options)) {
      cat(paste0(i - 1, ". ", options[i], "\n"))
    }
    
    choix <- readline(info_style("Veuillez choisir une option (par num√©ro) : "))
    
    if (choix == "0") {
      cat(question_style("\nRetour au menu P√©pitesHunter...
"))
      break
    } else if (choix %in% c("1", "2", "3", "4")) {
      option <- options[as.numeric(choix) + 1]
      cat(success_style(paste0("\nVous avez choisi : ", option, "\n")))
      
      # Message indiquant que la fonctionnalit√© est indisponible
      cat(warning_style("\nCette fonctionnalit√© est en cours de construction.\n"))
      cat(warning_style("\nMalheureusement, l'API Santiment est payante et n√©cessite un abonnement.\n"))
    } else {
      cat(warning_style("\nChoix invalide. Veuillez s√©lectionner un num√©ro parmi les options disponibles.\n"))
    }
  }
}

# Appel √† la fonction principale

##################################################
# Appel √† la fonction P√©pitesHunter
##################################################


pepite_hunter <- function() {
  cat(section_title_style("\nP√©pitesHunter - Cryptowise Copilote :\n"))
  cat(success_style("\n===========================================================\n"))
  cat(highlight_style("Bienvenue sur votre outil unique pour d√©tecter les signaux de probable run sur des cryptomonnaies prometteuses.\n"))
  cat(info_secondary_style("\nAvec P√©pitesHunter, vous pouvez :\n"))
  cat("- Analyser les cryptos les plus recherch√©es sur diff√©rentes plateformes.\n")
  cat("- Observer leur progression sur plusieurs p√©riodes temporelles.\n")
  cat("- Identifier les mouvements potentiels avant qu'ils ne deviennent des tendances majeures.\n")
  cat(info_secondary_style("\n Nos options:\n"))
  cat("- ", highlight_style("Signal Prix"), ": Observer en temps r√©el les variations de prix des cryptos et d√©tecter les signaux de rupture.\n")
  cat("- ", highlight_style("Volume et Trading"), ": Analyser les volumes de trading pour identifier les cryptos les plus liquides.\n")
  cat("- ", highlight_style("Statistiques Sociales"), ": Explorer les m√©triques sociales pour mesurer l‚Äôengagement et les opinions.\n")
  cat("- ", highlight_style("Analyse des Tendances et Recherches Populaires"), ": D√©couvrir les cryptos en vogue gr√¢ce √† des analyses des tendances actuelles.\n")
  cat("- ", highlight_style("Google Trend"), ": Suivre les recherches Google pour identifier les cryptos qui suscitent le plus d‚Äôint√©r√™t.\n")
  cat("- ", highlight_style("Lunar Crush"), ": Plonger dans les insights sociaux d√©taill√©s des cryptomonnaies.\n")
  cat("- ", highlight_style("Santiment"), ": √âtudier les donn√©es on-chain et le sentiment global du march√© crypto.\n")
  
  cat(success_style("===========================================================\n"))
  
  # T√©l√©charger les donn√©es une fois au d√©but
  download_coingecko_data()
  
  # V√©rifier si les donn√©es ont √©t√© correctement t√©l√©charg√©es
  if (is.null(coingecko_data) || nrow(coingecko_data) == 0) {
    cat(error_style("\nImpossible de continuer : les donn√©es n'ont pas √©t√© t√©l√©charg√©es correctement.\n"))
    return()
  }
  
  
  repeat {
    cat(section_title_style("\n=== Menu des outils P√©pitesHunter ===\n"))
    cat(question_style("0) Retour au menu principal\n"))
    cat("1) Signal Prix\n")
    cat("2) Volume et Trading\n")
    cat("3) Statistiques Sociales\n")
    cat("4) Analyse des Tendances et Recherches Populaires\n")
    cat("5) Google Trend\n")
    cat("6) Lunar Crush (", warning_style("restreinte"), ")\n")
    cat("7) Santiment (", warning_style("restreinte"), ")\n")
    
    
    choix <- readline(question_style("\nVotre choix : "))
    
    if (choix == "0") {
      cat(info_style("\nRetour au menu principal...\n"))
      break
    } else if (choix == "1") {
      process_price_signals(coingecko_data)
    } else if (choix == "2") {
      process_volume_trading(coingecko_data)
    } else if (choix == "3") {
      social_main_menu()
    } else if (choix == "4") {
      trend_menu()
    } else if (choix == "5") {
      cat(warning_style("\nGoogle Trend est en cours de d√©veloppement.\n"))
    } else if (choix == "6") {
      lunar_crush()
    } else if (choix == "7") {
      santiment()
    } else {
      cat(warning_style("\nOption invalide. Veuillez r√©essayer.\n"))
    }
  }
}


# Appel √† la fonction P√©pitesHunter
pepite_hunter()

